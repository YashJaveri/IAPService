(()=>{"use strict";var e={318:e=>{e.exports=JSON.parse('{"type":"service_account","project_id":"iapservice","private_key_id":"a359781f9938f704c806b45d05b5cbe880899c0a","private_key":"-----BEGIN PRIVATE KEY-----\\nMIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDLrRHcIjVJWAMT\\nCRqZ+ccn+gNv02xT8o+PMVPqBIUefDd7+3Txzz0rQsgcaaFy8qDVm4lZfWS536e8\\nw4B20HiSSacweJrxx4+yPVD7EYXBwtldU9fWrBI+NVJ+BH5U8Dfn3Yd7CElcpjrC\\nWgASvldeeI+rwgLTbmkqoWJOjfYZB670S4aOvpENeEVfv9BFdaae3EsXSrWMwduu\\nZkJa1YnwOH74qYAxs/5oVSTfYkwxZLh0bHdqzM1TR9mZhMIzIqnlX90RBAa7nMc+\\nPOugVsTNbuttN1Z/BsEfApyFaruMGv7SY5a9UH7ayJYPJm6k3//JSzBGkakSoAtL\\nNDMu/dVDAgMBAAECggEAKHatwaoaJAQUOEfqvQReiJam8CR0tQjPdIc8QJW9TJ0o\\n+LywMwoVAO83ik2CAbAqO8W2t8ytoi/Ixzuf3fr0uTtgt8R+I+Kdra940yhcBm6L\\neHsbuk5dIXa+eMKzxnQi5zGfpNW0nW945Pu0YATonqAdCuZ0YUTiJ9IAEdMqPTZq\\nuug76+G4/Zs7oeUfGMI0qLtP18SyzTwA/qTTe+1DbLU6vjr8whlT+UE1/EJeRNdH\\nWEtPPvXeGxgNwMg9tL+fgD7o6WH7Fv+UP6Fq5LG2CEB0YxlUi3quwqDp/J2EDGa+\\np1SB+BB05yDL3B+RQk2eAkjWaBRNhsQiuv74onb6oQKBgQDvYCXL+YxLtt8s9h8M\\nrMkoP1z5O2y9QhwozUgaUuIwXhzxObYYHUxDE+5kAncTjBRHeowluype6WAhnSWM\\nj6H5oTsJ7C66aKus8rNjgv730RUuSnnEz+aFmIrkF2wzlvMdli3KzF/yQ0i+0HNg\\nciSKKLQyaZxUBLOmZk4bGgmCBQKBgQDZ0jigoGkmcVWDHbe1t6K2oJ5f4FbhXfCH\\nLXMN+9L1phJItBA2MgO6plRdWBM0GYagVKmq6D1EyjTvQlRiw2hhnttEE7WsGSlZ\\n277OOjHq1V7qwq1f4kMv3AsYWbZ566m/I8RcP9rSwRIle1k2RaFDc6AuDnQU5U7p\\nMpHee600pwKBgQCM5Wv57q3clwwv28KU5FMWxI0GCitMDtCiV4o8LFMEozCn8A81\\njHEp/l5QMX9DWy1IkWJShyM+cGFsB6JlZNmzJGqqwYETqa57AvQB+8X1ufScpauc\\n475NHmeKMBs5Fn2NCat0de13nJEB95Ihz62gQKsoDS+96HKR3B/XJfE4vQKBgQCv\\nquDMelITFNf4FGFyhhUN4F+Zxx2KR+6Rtk/R+UPbpQGd7MoeSxvCzh2/4iYqoGN4\\nro7fLMkszz79rqrLs/hcsnb3YkXj867rr1Mkkr5rO4V/I14btCinUnkIPGHz1eFi\\nK4BTPZRG4Dq4S9BY+rLh6UBHpJRtvbl0TLpjia7YhQKBgQCBm55LBp0MpqvUgJcl\\nSy7OWDqg6PvGsuTdFV3jIzN78XSBkfI0RyPMygT224JDmnRYabcmIcS/bA4HnswT\\nfsTJG0/3RoDfr/fV7/FxsM+F10kh2YiLhmd0rlj2FNDJwaiJrTbsaymYutmmEJBO\\n7XZjJdiPbcFeasicUoB1wICscQ==\\n-----END PRIVATE KEY-----\\n","client_email":"firebase-adminsdk-q0hwn@iapservice.iam.gserviceaccount.com","client_id":"100681325628266909783","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://oauth2.googleapis.com/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_x509_cert_url":"https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-q0hwn%40iapservice.iam.gserviceaccount.com"}')},747:e=>{e.exports=require("fs")},778:e=>{e.exports=require("handlebars")},26:e=>{e.exports=require("iap")},123:e=>{e.exports=require("nodemailer")},487:e=>{e.exports=require("pdf-creator-node")}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var a=t[r]={exports:{}};return e[r](a,a.exports,n),a.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{const e=require("firebase-admin"),t=require("express");var r=n.n(t);const o=require("mongoose");var a=n.n(o);const i=require("cors");var l=n.n(i),s=[r().json({limit:"50mb"}),r().urlencoded({extended:!0})];const c=function(){function e(e,t,n){void 0===n&&(n=400),this.responseCode=400,this.message=t,this.resultCode=e,this.responseCode=n,this.name="ApiError"}return e.prototype.toResponseData=function(){return{message:this.message,resultCode:this.resultCode}},e}(),u=require("http");var f=n.n(u);function p(e){var t=this;return function(n,r,o){var a,i,l,s;(a=t,i=void 0,l=void 0,s=function(){return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(t){switch(t.label){case 0:return[4,e(n,r,o)];case 1:return t.sent(),[2]}}))},new(l||(l=Promise))((function(e,t){function n(e){try{o(s.next(e))}catch(e){t(e)}}function r(e){try{o(s.throw(e))}catch(e){t(e)}}function o(t){var o;t.done?e(t.value):(o=t.value,o instanceof l?o:new l((function(e){e(o)}))).then(n,r)}o((s=s.apply(a,i||[])).next())}))).catch((function(e){if("ApiError"===e.name)o(e);else{var t=new c("unknown-error",e.message,500);o(t)}}))}}var d=new o.Schema({firebaseId:{type:String,require:[!0,"Firebase id is required"]},name:{type:String,default:""},email:{type:String,require:[!0,"Email is required"]},phoneNumber:{type:String,unique:!0,default:""},apiKey:{type:String,default:""},billingEnabled:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},googleConfig:{type:{},default:null},appleConfig:{type:{secret:{type:String,default:""}},default:{secret:""}},amazonConfig:{type:{userId:{type:String,default:""},secret:{type:String,default:""}},default:{userId:"",secret:""}}}),h=(0,o.model)("user",d);const y=require("uuid-apikey");var b=n.n(y),m=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{s(r.next(e))}catch(e){a(e)}}function l(e){try{s(r.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,l)}s((r=r.apply(e,t||[])).next())}))},g=function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},v=function(){function e(e,t,n){this.message="",this.resultCode="00",this.data={},this.data=e,this.message=n,this.resultCode=t}return e.prototype.toJSON=function(){return{data:this.data,message:this.message,resultCode:this.resultCode}},e}(),w=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{s(r.next(e))}catch(e){a(e)}}function l(e){try{s(r.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,l)}s((r=r.apply(e,t||[])).next())}))},x=function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},S=(0,t.Router)();S.use(function(){var t=this;return p((function(n,r,o){return m(t,void 0,void 0,(function(){var t,r,a=this;return g(this,(function(i){switch(i.label){case 0:return(t=null===(r=n.headers.authorization)||void 0===r?void 0:r.replace("Bearer ","").trim())?[4,e.auth().verifyIdToken(t).then((function(e){return m(a,void 0,void 0,(function(){var t,r,a;return g(this,(function(i){switch(i.label){case 0:return t=e.uid,[4,h.findOne({firebaseId:t})];case 1:return(r=i.sent())?(n.user=r,o()):(console.log("User not found hence creating"),a={firebaseId:t,email:e.email,apiKey:b().create().apiKey},h.create(a,(function(e,t){if(e)throw console.log("Error creating: "+e.message),new c("failed-creating-object",e.message);n.user=t,o()}))),[2]}}))}))})).catch((function(e){throw new c("user-not-found","User not found!",404)}))]:[3,2];case 1:return i.sent(),[3,3];case 2:throw new c("invalid-jwt","Invalid jwt",401);case 3:return[2]}}))}))}))}()),S.post("/",p((function(e,t){return w(void 0,void 0,void 0,(function(){var n,r;return x(this,(function(o){switch(o.label){case 0:Object.assign(e.user,e.body),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,e.user.save()];case 2:return void 0!==(n=o.sent())&&t.send(new v(n).toJSON()),[3,4];case 3:throw r=o.sent(),console.log(r),new c("unknown-error",r.message,400);case 4:return[2]}}))}))}))),S.get("/",p((function(e,t){return w(void 0,void 0,void 0,(function(){return x(this,(function(n){return t.send(new v(e.user).toJSON()),[2]}))}))})));var E={RATE_PER_REQUEST:.3,GRACE_PERIOD:7,FREE_ALLOWANCE:50,MONTH_NAMES:["January","February","March","April","May","June","July","August","September","October","November","December"]},k=new o.Schema({userId:{type:String,require:[!0,"User Id is required"]},requestsStats:{type:[{date:{type:Number,require:[!0,"Date is required"]},platform:{type:String,require:[!0,"Platform is required"]},appId:{type:String,require:[!0,"AppId is required"]},countForThisCombo:{type:Number}}]}}),A=(0,o.model)("userStatistic",k),D=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,a=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(r=a.next()).done;)i.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=a.return)&&n.call(a)}finally{if(o)throw o.error}}return i};function q(e,t,n,r,o){return void 0===r&&(r=""),void 0===o&&(o=""),a=this,i=void 0,s=function(){var a,i,l,s,c,u,f,p,d,h,y,b,m,g,v,w,x,S,k,q;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(I){switch(I.label){case 0:return[4,A.findOne({userId:e._id})];case 1:if(a=I.sent()){for(i=null==a?void 0:a.requestsStats.filter((function(e){return t===new Date(e.date).getMonth()&&n===new Date(e.date).getFullYear()})),l=0,s=new Map,c=0;c<i.length;c++)u=i[c].countForThisCombo,l+=u,f=i[c].platform,p=i[c].appId,g=f+" "+p,void 0===s.get(g)?s.set(g,u):(d=s.get(g),s.set(g,d+u));h=[];try{for(y=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(s.entries()),b=y.next();!b.done;b=y.next())m=D(b.value,2),g=m[0],v=m[1],w={platform:g.split(" ")[0],appId:g.split(" ")[1],count:v,totalPrice:v*E.RATE_PER_REQUEST},h.push(w)}catch(e){k={error:e}}finally{try{b&&!b.done&&(q=y.return)&&q.call(y)}finally{if(k)throw k.error}}return x={rate:E.RATE_PER_REQUEST,freeAllowance:E.FREE_ALLOWANCE,totalCount:l,statistics:h},""!==o&&""===r?(S=x.statistics.filter((function(e){return e.appId===o})),x.statistics=S):""!==r&&""===o?(S=x.statistics.filter((function(e){return e.platform===r})),x.statistics=S):""!==r&&""!==o&&(S=x.statistics.filter((function(e){return e.platform===r&&e.appId===o})),x.statistics=S),[2,x]}return[2,{rate:E.RATE_PER_REQUEST,freeAllowance:E.FREE_ALLOWANCE,totalCount:0,statistics:[]}]}}))},new((l=void 0)||(l=Promise))((function(e,t){function n(e){try{o(s.next(e))}catch(e){t(e)}}function r(e){try{o(s.throw(e))}catch(e){t(e)}}function o(t){var o;t.done?e(t.value):(o=t.value,o instanceof l?o:new l((function(e){e(o)}))).then(n,r)}o((s=s.apply(a,i||[])).next())}));var a,i,l,s}var I=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{s(r.next(e))}catch(e){a(e)}}function l(e){try{s(r.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,l)}s((r=r.apply(e,t||[])).next())}))},T=function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},C=n(26),R=(0,t.Router)();R.use(function(){var e=this;return p((function(t,n,r){return o=e,a=void 0,l=function(){var e,n;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(o){switch(o.label){case 0:return(e=t.query.apiKey)?[4,h.findOne({apiKey:e})]:[3,2];case 1:if(n=o.sent(),console.log("User: "+n),!n)throw new c("invalid-api-key","User not found. Invalid Api key",404);return t.user=n,r(),[3,3];case 2:throw new c("no-api-key-found","No api key",401);case 3:return[2]}}))},new((i=void 0)||(i=Promise))((function(e,t){function n(e){try{s(l.next(e))}catch(e){t(e)}}function r(e){try{s(l.throw(e))}catch(e){t(e)}}function s(t){var o;t.done?e(t.value):(o=t.value,o instanceof i?o:new i((function(e){e(o)}))).then(n,r)}s((l=l.apply(o,a||[])).next())}));var o,a,i,l}))}()),R.post("/",p((function(e,t,n){return I(void 0,void 0,void 0,(function(){var n,r,o;return T(this,(function(a){switch(a.label){case 0:return n=e.body.platform,r=e.body.paymentData,e.user.disabled?[3,5]:[4,q(e.user,(new Date).getMonth(),(new Date).getFullYear())];case 1:if(o=a.sent().totalCount,e.user.billingEnabled||!(o>=E.FREE_ALLOWANCE))return[3,2];throw new c("billing-disabled","Request rejected. You have exceeded the free limit. Kindly enable the billing option to continue using our service!");case 2:return function(e,t,n){var r,o,a,i,l;o=this,a=void 0,l=function(){var o,a,i;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(l){switch(l.label){case 0:return[4,A.findOne({userId:e._id})];case 1:return(o=l.sent())?[3,2]:(a=function(e,t,n,r,o){return{userId:e,requestsStats:[{date:Date.now(),platform:t,appId:n,countForThisCombo:1}]}}(e._id,t,n),A.create(a,(function(e,t){if(e)throw new c("failed-creating-object",e.message)})),[3,4]);case 2:return-1==(i=o.requestsStats.findIndex((function(e){return new Date(e.date).toDateString()==(new Date).toDateString()&&e.platform===t&&e.appId===n})))?null===(r=o.requestsStats)||void 0===r||r.push({date:Date.now(),platform:t,appId:n,countForThisCombo:1}):o.requestsStats[i].countForThisCombo=o.requestsStats[i].countForThisCombo+1,[4,o.save()];case 3:l.sent(),l.label=4;case 4:return[2]}}))},new((i=void 0)||(i=Promise))((function(e,t){function n(e){try{s(l.next(e))}catch(e){t(e)}}function r(e){try{s(l.throw(e))}catch(e){t(e)}}function s(t){var o;t.done?e(t.value):(o=t.value,o instanceof i?o:new i((function(e){e(o)}))).then(n,r)}s((l=l.apply(o,a||[])).next())}))}(e.user,n,r.packageName),[4,new Promise((function(e,o){C.verifyPayment(n,r,(function(n,r){return I(void 0,void 0,void 0,(function(){return T(this,(function(a){return r?(e(r),t.send(new v(r))):o(new c("verification-failed",n.message,400)),[2]}))}))}))}))];case 3:a.sent(),a.label=4;case 4:return[3,6];case 5:throw new c("user-disabled","Request rejected. Kindly complete your previous pending payment to continue using our service!");case 6:return[2]}}))}))})));var M=(0,t.Router)();M.use("/auth/profile",S),M.use("/verify",R);const P=require("cron");var N=new o.Schema({userId:{type:String,require:[!0]},invoiceDisplayId:{type:Number,require:[!0]},billDetails:{type:{rate:{type:Number,require:[!0]},freeAllowance:{type:Number,require:[!0]},totalCount:{type:Number,require:[!0]},statistics:{type:[{platform:{type:String,require:[!0]},appId:{type:String,require:[!0]},count:{type:Number,require:[!0]},totalPrice:{type:Number,require:[!0]}}]}},require:[!0]},amount:{type:Number,require:[!0]},currencyCode:{type:String},transactionId:{type:String},paid:{type:Boolean,default:!1}},{timestamps:!0}),_=(0,o.model)("invoice",N);function O(){return'<!DOCTYPE html>\n    <html>\n        <head>\n            <meta charset="utf-8">\n            <meta http-equiv="x-ua-compatible" content="ie=edge">\n            <title>Invoice</title>\n            <meta name="viewport" content="width=device-width, initial-scale=1">\n            <link rel="preconnect" href="https://fonts.gstatic.com">\n            <link href="https://fonts.googleapis.com/css2?family=Coda&display=swap" rel="stylesheet">\n            <link href="https://fonts.googleapis.com/css2?family=Coda:wght@400;800&display=swap" rel="stylesheet">\n            <style type="text/css">\n                * {\n                    font-family: \'Coda\';\n                }\n        \n                body,\n                table,\n                td,\n                a {\n        \n                    -ms-text-size-adjust: 100%;\n                    /* 1 */\n                    -webkit-text-size-adjust: 100%;\n                    /* 2 */\n                }\n        \n                /**\n         * Remove extra space added to tables and cells in Outlook.\n         */\n                table,\n                td {\n                    mso-table-rspace: 0pt;\n                    mso-table-lspace: 0pt;\n                }\n        \n                /**\n         * Better fluid images in Internet Explorer.\n         */\n                img {\n                    -ms-interpolation-mode: bicubic;\n                }\n        \n                /**\n         * Remove blue links for iOS devices.\n         */\n                a[x-apple-data-detectors] {\n                    font-family: inherit !important;\n                    font-size: inherit !important;\n                    font-weight: inherit !important;\n                    line-height: inherit !important;\n                    color: inherit !important;\n                    text-decoration: none !important;\n                }\n        \n                /**\n         * Fix centering issues in Android 4.4.\n         */\n                div[style*="margin: 16px 0;"] {\n                    margin: 0 !important;\n                }\n        \n                body {\n                    width: 100% !important;\n                    height: 100% !important;\n                    padding: 0 !important;\n                    margin: 0 !important;\n                }\n                table {\n                    border-collapse: collapse !important;\n                }\n        \n                a {\n                    color: #fc5350;\n                }\n        \n                img {\n                    height: auto;\n                    line-height: 100%;\n                    text-decoration: none;\n                    border: 0;\n                    outline: none;\n                }\n            </style>\n        \n        </head>\n        \n        <body style="background-color: #e9ecef;">\n        \n            \x3c!-- start preheader --\x3e\n            <div class="preheader"\n                style="display: none; max-width: 0; max-height: 0; overflow: hidden; font-size: 1px; line-height: 1px; color: #fff; opacity: 0;">\n                Invoice\n            </div>\n            \x3c!-- end preheader --\x3e\n        \n            \x3c!-- start body --\x3e\n            <table border="0" cellpadding="0" cellspacing="0" width="100%">\n        \n                \x3c!-- start logo --\x3e\n                <tr>\n                    <td align="center" bgcolor="#e9ecef">\n\n                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px;">\n                            <tr>\n                                <td align="center" valign="top" style="padding: 18px 12px;">\n                                    \n                                </td>\n                            </tr>\n                        </table>\n                    </td>\n                </tr>\n                \x3c!-- end logo --\x3e\n        \n                \x3c!-- start hero --\x3e\n                <tr>\n                    <td align="center" bgcolor="#e9ecef">\n                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px;">\n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 36px 24px 0; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; border-top: 3px solid #d4dadf;">\n                                    <h1\n                                        style="margin: 0; font-size: 32px; font-weight: 700; letter-spacing: -1px; line-height: 48px;">\n                                        Your invoice for {{month}} is ready</h1>\n                                </td>\n                            </tr>\n                        </table>\n                        \x3c!--[if (gte mso 9)|(IE)]>\n                </td>\n                </tr>\n                </table>\n                <![endif]--\x3e\n                    </td>\n                </tr>\n                \x3c!-- end hero --\x3e\n        \n                \x3c!-- start copy block --\x3e\n                <tr>\n                    <td align="center" bgcolor="#e9ecef">\n                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px;">\n        \n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 24px; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; font-size: 16px; line-height: 24px;">\n                                    <p style="margin: 0;">We thank you for using our service!</p>\n                                </td>\n                            </tr>\n                            \n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 24px; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; font-size: 16px; line-height: 24px;">\n                                    <p style="margin: 0;">Your invoice for {{month}}, {{year}} is ready. Kindly make the payment <a style="color: #fc5350;" href={{paymentUrl}} target="_blank">here</a> by {{dueDate}}. You can also complete the payment by visiting your dashboard at\n                                    <a style="color: #fc5350;" href="www.somewebsite.com" target="_blank">www.somewebsite.com</a></p>\n                                    </p>\n                                    <p style="margin: 0;">If the pdf looks corrupted. Kindly contact us at</p>\n                                    <a style="color: #fc5350;" href="hello@cryvis.com" target="_blank">hello@cryvis.com</a>\n                                </td>\n                            </tr>\n        \n                            \x3c!-- start copy --\x3e\n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 24px; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; font-size: 16px; line-height: 24px; border-bottom: 3px solid #d4dadf">\n                                    <p style="margin: 0;">Cheers,<br> Team Cryvis</p>\n                                </td>\n                            </tr>\n                            \x3c!-- end copy --\x3e\n        \n                        </table>\n                    </td>\n                </tr>\n            </table>        \n        </body>\n        </html>'}n(778);var B=n(123),F=n(747),Y=n(778);function z(e,t,n,r,o,a,i,l){var s=B.createTransport({service:"gmail",auth:{user:"astronauak@gmail.com",pass:"Astronaut@123"}});console.log("before template");var c=Y.compile(l());console.log("after template");var u={from:"astronauak@gmail.com",to:"rushabhshroff98@gmail.com",subject:n,html:c({dueDate:r.toLocaleString(),month:o,year:a,paymentUrl:i}),attachments:[{filename:"invoice.pdf",path:"./src/pdfstorage/output.pdf"}]};s.sendMail(u,(function(e,t){e?console.log(e):(console.log("Email sent: "+t.response),F.unlinkSync("./src/pdfstorage/output.pdf"))}))}var U=n(487),J=n(747),j={};function L(e){return t=this,n=void 0,o=function(){var t,n;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(r){switch(r.label){case 0:return[4,J.readFileSync("src/utils/html/invoice.html","utf8")];case 1:return t=r.sent(),n={html:t,data:{bill:e},path:"./src/pdfstorage/output.pdf",type:""},[4,U.create(n,j).then((function(e){console.log(e)})).catch((function(e){console.error(e)}))];case 2:return r.sent(),console.log("Pdf created"),[2]}}))},new((r=void 0)||(r=Promise))((function(e,a){function i(e){try{s(o.next(e))}catch(e){a(e)}}function l(e){try{s(o.throw(e))}catch(e){a(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,l)}s((o=o.apply(t,n||[])).next())}));var t,n,r,o}var H=new P.CronJob("* * * * *",(function(){return e=this,t=void 0,r=function(){var e,t,n,r,o,a,i,l,s,c,u,f,p,d,y;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(b){switch(b.label){case 0:return[4,h.find({})];case 1:e=b.sent(),t=new Date((new Date).setDate((new Date).getDate()+7)),0===(new Date).getMonth()?(n=E.MONTH_NAMES[11],r=(new Date).getFullYear()-1):(n=E.MONTH_NAMES[(new Date).getMonth()-1],r=r=(new Date).getFullYear()),b.label=2;case 2:b.trys.push([2,13,14,15]),o=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(e),a=o.next(),b.label=3;case 3:return a.done?[3,12]:(i=a.value,0!==(new Date).getMonth()?[3,5]:[4,q(i,11,(new Date).getFullYear()-1)]);case 4:return l=b.sent(),[3,7];case 5:return[4,q(i,(new Date).getMonth()-1,(new Date).getFullYear())];case 6:l=b.sent(),b.label=7;case 7:return(s=Math.max(0,l.totalCount-E.FREE_ALLOWANCE)*E.RATE_PER_REQUEST)>0?[4,_.findOne({},{},{sort:{created_at:-1}})]:[3,11];case 8:return c=b.sent(),u=c?(c.invoiceDisplayId+1)%Math.pow(10,7):1,[4,_.create({userId:i._id,invoiceDisplayId:u,billDetails:l,amount:s})];case 9:return f=b.sent(),Object.assign(l,{name:i.name,email:i.email,invoiceId:f.invoiceDisplayId,dueDate:t.toDateString(),currDate:(new Date).toDateString(),subTotal:l.totalCount*E.RATE_PER_REQUEST,billedRequests:Math.max(0,l.totalCount-E.FREE_ALLOWANCE),amountPayable:s}),[4,L(l)];case 10:b.sent(),z(0,i.email,"Test Mail",t,n,r,"www.google.com",O),b.label=11;case 11:return a=o.next(),[3,3];case 12:return[3,15];case 13:return p=b.sent(),d={error:p},[3,15];case 14:try{a&&!a.done&&(y=o.return)&&y.call(o)}finally{if(d)throw d.error}return[7];case 15:return[2]}}))},new((n=void 0)||(n=Promise))((function(o,a){function i(e){try{s(r.next(e))}catch(e){a(e)}}function l(e){try{s(r.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,l)}s((r=r.apply(e,t||[])).next())}));var e,t,n,r}),null,!0,"Asia/Kolkata");function K(){return'<!DOCTYPE html>\n    <html>\n        <head>\n            <meta charset="utf-8">\n            <meta http-equiv="x-ua-compatible" content="ie=edge">\n            <title>Invoice</title>\n            <meta name="viewport" content="width=device-width, initial-scale=1">\n            <link rel="preconnect" href="https://fonts.gstatic.com">\n            <link href="https://fonts.googleapis.com/css2?family=Coda&display=swap" rel="stylesheet">\n            <link href="https://fonts.googleapis.com/css2?family=Coda:wght@400;800&display=swap" rel="stylesheet">\n            <style type="text/css">\n                * {\n                    font-family: \'Coda\';\n                }\n        \n                body,\n                table,\n                td,\n                a {\n        \n                    -ms-text-size-adjust: 100%;\n                    /* 1 */\n                    -webkit-text-size-adjust: 100%;\n                    /* 2 */\n                }\n        \n                /**\n         * Remove extra space added to tables and cells in Outlook.\n         */\n                table,\n                td {\n                    mso-table-rspace: 0pt;\n                    mso-table-lspace: 0pt;\n                }\n        \n                /**\n         * Better fluid images in Internet Explorer.\n         */\n                img {\n                    -ms-interpolation-mode: bicubic;\n                }\n        \n                /**\n         * Remove blue links for iOS devices.\n         */\n                a[x-apple-data-detectors] {\n                    font-family: inherit !important;\n                    font-size: inherit !important;\n                    font-weight: inherit !important;\n                    line-height: inherit !important;\n                    color: inherit !important;\n                    text-decoration: none !important;\n                }\n        \n                /**\n         * Fix centering issues in Android 4.4.\n         */\n                div[style*="margin: 16px 0;"] {\n                    margin: 0 !important;\n                }\n        \n                body {\n                    width: 100% !important;\n                    height: 100% !important;\n                    padding: 0 !important;\n                    margin: 0 !important;\n                }\n                table {\n                    border-collapse: collapse !important;\n                }\n        \n                a {\n                    color: #fc5350;\n                }\n        \n                img {\n                    height: auto;\n                    line-height: 100%;\n                    text-decoration: none;\n                    border: 0;\n                    outline: none;\n                }\n            </style>\n        \n        </head>\n        \n        <body style="background-color: #e9ecef;">\n        \n            \x3c!-- start preheader --\x3e\n            <div class="preheader"\n                style="display: none; max-width: 0; max-height: 0; overflow: hidden; font-size: 1px; line-height: 1px; color: #fff; opacity: 0;">\n                Invoice\n            </div>\n            \x3c!-- end preheader --\x3e\n        \n            \x3c!-- start body --\x3e\n            <table border="0" cellpadding="0" cellspacing="0" width="100%">\n        \n                \x3c!-- start logo --\x3e\n                <tr>\n                    <td align="center" bgcolor="#e9ecef">\n\n                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px;">\n                            <tr>\n                                <td align="center" valign="top" style="padding: 18px 12px;">\n                                    \n                                </td>\n                            </tr>\n                        </table>\n                    </td>\n                </tr>\n                \x3c!-- end logo --\x3e\n        \n                \x3c!-- start hero --\x3e\n                <tr>\n                    <td align="center" bgcolor="#e9ecef">\n                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px;">\n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 36px 24px 0; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; border-top: 3px solid #d4dadf;">\n                                    <h1\n                                        style="margin: 0; font-size: 32px; font-weight: 700; letter-spacing: -1px; line-height: 48px;">\n                                        Your payment is due</h1>\n                                </td>\n                            </tr>\n                        </table>\n                        \x3c!--[if (gte mso 9)|(IE)]>\n                </td>\n                </tr>\n                </table>\n                <![endif]--\x3e\n                    </td>\n                </tr>\n                \x3c!-- end hero --\x3e\n        \n                \x3c!-- start copy block --\x3e\n                <tr>\n                    <td align="center" bgcolor="#e9ecef">\n                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px;">\n        \n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 24px; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; font-size: 16px; line-height: 24px;">\n                                    <p style="margin: 0;">We thank you for using our service!</p>\n                                </td>\n                            </tr>\n                     \n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 24px; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; font-size: 16px; line-height: 24px;">\n                                    <p style="margin: 0;">The due date for completing the payment has passed.\n                                    Your service is suspended.\n                                    Kindly complete your payment for the last month, <a style="color: #fc5350;" href={{paymentUrl}} target="_blank">here</a> to continue using our service. \n                                    You can also complete the payment by visiting your dashboard at\n                                    <a style="color: #fc5350;" href="www.somewebsite.com" target="_blank">www.somewebsite.com</a></p>\n                                    </p>\n                                    <p style="margin: 0;">If the pdf looks corrupted. Kindly contact us at</p>\n                                    <a style="color: #fc5350;" href="hello@cryvis.com" target="_blank">hello@cryvis.com</a>\n                                </td>\n                            </tr>\n        \n                            \x3c!-- start copy --\x3e\n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 24px; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; font-size: 16px; line-height: 24px; border-bottom: 3px solid #d4dadf">\n                                    <p style="margin: 0;">Cheers,<br> Team Cryvis</p>\n                                </td>\n                            </tr>\n                            \x3c!-- end copy --\x3e\n        \n                        </table>\n                    </td>\n                </tr>\n            </table>        \n        </body>\n        </html>'}n(778);var Q=new P.CronJob("* * * * *",(function(){return e=this,t=void 0,r=function(){var e,t,n,r,o,a,i,l,s,c,u,f;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(p){switch(p.label){case 0:return[4,h.find({})];case 1:e=p.sent(),t=new Date((new Date).setDate((new Date).getDate()+7)),0===(new Date).getMonth()?(n=E.MONTH_NAMES[11],r=(new Date).getFullYear()-1):(n=E.MONTH_NAMES[(new Date).getMonth()-1],r=r=(new Date).getFullYear()),p.label=2;case 2:p.trys.push([2,9,10,11]),o=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(e),a=o.next(),p.label=3;case 3:return a.done?[3,8]:(i=a.value,[4,_.findOne({userId:i._id},{},{sort:{created_at:-1}})]);case 4:return!(l=p.sent())||(null==l?void 0:l.paid)?[3,7]:(s=l.billDetails,Object.assign(s,{name:i.name,email:i.email,invoiceId:l.invoiceDisplayId,dueDate:t.toDateString(),currDate:(new Date).toDateString(),subTotal:s.totalCount*E.RATE_PER_REQUEST,billedRequests:Math.max(0,s.totalCount-E.FREE_ALLOWANCE),amountPayable:l.amount}),console.log("Cron grace running..."),[4,L(s)]);case 5:return p.sent(),z(0,i.email,"Test Mail",t,n,r,"www.google.com",K),i.disabled=!0,[4,i.save()];case 6:p.sent(),p.label=7;case 7:return a=o.next(),[3,3];case 8:return[3,11];case 9:return c=p.sent(),u={error:c},[3,11];case 10:try{a&&!a.done&&(f=o.return)&&f.call(o)}finally{if(u)throw u.error}return[7];case 11:return[2]}}))},new((n=void 0)||(n=Promise))((function(o,a){function i(e){try{s(r.next(e))}catch(e){a(e)}}function l(e){try{s(r.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,l)}s((r=r.apply(e,t||[])).next())}));var e,t,n,r}),null,!0,"Asia/Kolkata"),G=r()(),W=n(318);H.start(),Q.start(),e.initializeApp({credential:e.credential.cert(W)}),G.use(l()()),G.use(s),G.use(M),G.use((function(e,t,n,r){e.constructor===c&&"ApiError"===e.name?n.status(e.responseCode).send(e.toResponseData()):(n.sendStatus(500),console.log(e))}));var V=f().createServer(G);a().connect("mongodb://127.0.0.1:27017/IAPService",{useNewUrlParser:!0,useUnifiedTopology:!0,useCreateIndex:!0}).then((function(){V.listen(process.env.PORT||8080,(function(){console.log("Server Running...")}))}))})()})();