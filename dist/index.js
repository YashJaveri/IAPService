(()=>{"use strict";var e={318:e=>{e.exports=JSON.parse('{"type":"service_account","project_id":"iapservice","private_key_id":"a359781f9938f704c806b45d05b5cbe880899c0a","private_key":"-----BEGIN PRIVATE KEY-----\\nMIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDLrRHcIjVJWAMT\\nCRqZ+ccn+gNv02xT8o+PMVPqBIUefDd7+3Txzz0rQsgcaaFy8qDVm4lZfWS536e8\\nw4B20HiSSacweJrxx4+yPVD7EYXBwtldU9fWrBI+NVJ+BH5U8Dfn3Yd7CElcpjrC\\nWgASvldeeI+rwgLTbmkqoWJOjfYZB670S4aOvpENeEVfv9BFdaae3EsXSrWMwduu\\nZkJa1YnwOH74qYAxs/5oVSTfYkwxZLh0bHdqzM1TR9mZhMIzIqnlX90RBAa7nMc+\\nPOugVsTNbuttN1Z/BsEfApyFaruMGv7SY5a9UH7ayJYPJm6k3//JSzBGkakSoAtL\\nNDMu/dVDAgMBAAECggEAKHatwaoaJAQUOEfqvQReiJam8CR0tQjPdIc8QJW9TJ0o\\n+LywMwoVAO83ik2CAbAqO8W2t8ytoi/Ixzuf3fr0uTtgt8R+I+Kdra940yhcBm6L\\neHsbuk5dIXa+eMKzxnQi5zGfpNW0nW945Pu0YATonqAdCuZ0YUTiJ9IAEdMqPTZq\\nuug76+G4/Zs7oeUfGMI0qLtP18SyzTwA/qTTe+1DbLU6vjr8whlT+UE1/EJeRNdH\\nWEtPPvXeGxgNwMg9tL+fgD7o6WH7Fv+UP6Fq5LG2CEB0YxlUi3quwqDp/J2EDGa+\\np1SB+BB05yDL3B+RQk2eAkjWaBRNhsQiuv74onb6oQKBgQDvYCXL+YxLtt8s9h8M\\nrMkoP1z5O2y9QhwozUgaUuIwXhzxObYYHUxDE+5kAncTjBRHeowluype6WAhnSWM\\nj6H5oTsJ7C66aKus8rNjgv730RUuSnnEz+aFmIrkF2wzlvMdli3KzF/yQ0i+0HNg\\nciSKKLQyaZxUBLOmZk4bGgmCBQKBgQDZ0jigoGkmcVWDHbe1t6K2oJ5f4FbhXfCH\\nLXMN+9L1phJItBA2MgO6plRdWBM0GYagVKmq6D1EyjTvQlRiw2hhnttEE7WsGSlZ\\n277OOjHq1V7qwq1f4kMv3AsYWbZ566m/I8RcP9rSwRIle1k2RaFDc6AuDnQU5U7p\\nMpHee600pwKBgQCM5Wv57q3clwwv28KU5FMWxI0GCitMDtCiV4o8LFMEozCn8A81\\njHEp/l5QMX9DWy1IkWJShyM+cGFsB6JlZNmzJGqqwYETqa57AvQB+8X1ufScpauc\\n475NHmeKMBs5Fn2NCat0de13nJEB95Ihz62gQKsoDS+96HKR3B/XJfE4vQKBgQCv\\nquDMelITFNf4FGFyhhUN4F+Zxx2KR+6Rtk/R+UPbpQGd7MoeSxvCzh2/4iYqoGN4\\nro7fLMkszz79rqrLs/hcsnb3YkXj867rr1Mkkr5rO4V/I14btCinUnkIPGHz1eFi\\nK4BTPZRG4Dq4S9BY+rLh6UBHpJRtvbl0TLpjia7YhQKBgQCBm55LBp0MpqvUgJcl\\nSy7OWDqg6PvGsuTdFV3jIzN78XSBkfI0RyPMygT224JDmnRYabcmIcS/bA4HnswT\\nfsTJG0/3RoDfr/fV7/FxsM+F10kh2YiLhmd0rlj2FNDJwaiJrTbsaymYutmmEJBO\\n7XZjJdiPbcFeasicUoB1wICscQ==\\n-----END PRIVATE KEY-----\\n","client_email":"firebase-adminsdk-q0hwn@iapservice.iam.gserviceaccount.com","client_id":"100681325628266909783","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://oauth2.googleapis.com/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_x509_cert_url":"https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-q0hwn%40iapservice.iam.gserviceaccount.com"}')},605:(e,t,n)=>{const r={amazon:n(755),apple:n(532),google:n(144),roku:n(469)};t.verifyPayment=function(e,t,n){function o(e){process.nextTick((function(){n(e)}))}if(!t)return o(new Error("No payment given"));const i=r[e];if(!i)return o(new Error(`Platform ${e} not recognized`));i.verifyPayment(t,(function(t,r){if(t)return n(t);r.platform=e,n(null,r)}))},t.cancelSubscription=function(e,t,n){function o(e){process.nextTick((function(){n(e)}))}if(!t)return o(new Error("No payment given"));const i=r[e];return i?i.cancelSubscription?void i.cancelSubscription(t,(function(e,t){if(e)return n(e);n(null,t)})):o(new Error(`Platform ${e} does not have cancelSubscription method`)):o(new Error(`Platform ${e} not recognized`))}},755:(e,t,n)=>{const r=n(357),o=n(20);t.verifyPayment=function(e,t){try{r.equal(typeof e.secret,"string","Shared secret must be a string"),r.equal(typeof e.userId,"string","User ID must be a string"),r.equal(typeof e.receipt,"string","Receipt must be a string")}catch(e){return process.nextTick((function(){t(e)}))}const n=`${"https://appstore-sdk.amazon.com/version/1.0/verifyReceiptId/developer/"+e.secret}/user/${e.userId}/receiptId/${e.receipt}`;o.get(n,null,(function(e,n,r){if(e)return t(e);let o=null;try{o=function(e){const t=JSON.parse(e),n=t.purchaseDate?parseInt(t.purchaseDate,10):null;let r=null;return t.cancelDate?r=parseInt(t.cancelDate,10):t.renewalDate&&(r=parseInt(t.renewalDate,10)),{receipt:t,transactionId:t.receiptId,productId:t.productId,purchaseDate:n,expirationDate:r}}(r)}catch(e){return t(e)}return 400===n.statusCode?t(new Error("receiptId is invalid, or no transaction was found for this receiptId")):496===n.statusCode?t(new Error("Invalid sharedSecret")):497===n.statusCode?t(new Error("Invalid User ID")):500===n.statusCode?t(new Error("There was an Internal Servor Error")):200!==n.statusCode?t(new Error("Unknown operation exception")):void t(null,o)}))}},532:(e,t,n)=>{const r=n(357),o=n(20),i={21e3:"The App Store could not read the JSON object you provided.",21002:"The data in the receipt-data property was malformed or missing.",21003:"The receipt could not be authenticated.",21004:"The shared secret you provided does not match the shared secret on file for your account.",21005:"The receipt server is not currently available.",21006:"This receipt is valid but the subscription has expired. When this status code is returned to your server, the receipt data is also decoded and returned as part of the response.",21007:"This receipt is from the test environment, but it was sent to the production service for verification. Send it to the test environment service instead.",21008:"This receipt is from the production receipt, but it was sent to the test environment service for verification. Send it to the production environment service instead.",21009:"Internal data access error. Try again later.",21010:"The user account cannot be found or has been deleted."};function a(e,t){if(e.hasOwnProperty(t))return e[t];if(e.hasOwnProperty("in_app")&&e.in_app[0]){const n=e.in_app.reduce(((e,t)=>e.purchase_date_ms>t.purchase_date_ms?e:t));return n.hasOwnProperty(t)?n[t]:null}return null}function s(e){return e?parseInt(e,10):null}function c(e,t,n){o.post(e,t,(function(e,t,r){if(e)return n(e);if(200!==t.statusCode)return n({statusCode:t.statusCode,error:r});let o;try{o=function(e){e=JSON.parse(e);const t=parseInt(e.status,10);let n=null;if(0!==t&&21006!==t){const e=new Error(i[t]||`Unknown status code: ${t}`);throw e.status=t,e}let r=a(e.receipt,"product_id"),o=a(e.receipt,"transaction_id"),c=s(a(e.receipt,"purchase_date_ms")),u=s(a(e.receipt,"expires_date_ms")||a(e.receipt,"expires_date"));const l=a(e,"latest_expired_receipt_info"),p=a(e,"pending_renewal_info");if(e.hasOwnProperty("latest_receipt_info"))if(Array.isArray(e.latest_receipt_info)&&e.latest_receipt_info.length>0){n=e.latest_receipt_info.sort((function(e,t){return parseInt(e.transaction_id,10)-parseInt(t.transaction_id,10)}));const t=n[n.length-1];r=t.product_id,o=t.transaction_id,c=s(t.purchase_date_ms),u=s(t.expires_date_ms||t.expires_date)}else e.latest_receipt_info&&e.latest_receipt_info.transaction_id&&(n=[e.latest_receipt_info],r=e.latest_receipt_info.product_id,o=e.latest_receipt_info.transaction_id,c=s(e.latest_receipt_info.purchase_date_ms),u=s(e.latest_receipt_info.expires_date_ms||e.latest_receipt_info.expires_date));return l&&l.cancellation_date_ms&&(u=s(l.cancellation_date_ms)),{receipt:e.receipt,latestReceiptInfo:n,latestExpiredReceiptInfo:l,productId:r,transactionId:o,purchaseDate:c,expirationDate:u,pendingRenewalInfo:p}}(r)}catch(e){return n(e)}n(null,o)}))}t.verifyPayment=function(e,t){const n={};try{r.equal(typeof e.receipt,"string","Receipt must be a string"),o=e.receipt,Boolean(o.match(/^[a-zA-Z0-9/+]+={0,2}$/))?n["receipt-data"]=e.receipt:n["receipt-data"]=Buffer.from(e.receipt,"utf8").toString("base64")}catch(e){return process.nextTick((function(){t(e)}))}var o;function i(n,r,o){if(n)return t(n);const i=r.receipt,s=a(i,"product_id");if(e.hasOwnProperty("productId")&&e.productId!==s)return t(new Error(`Wrong product ID: ${e.productId} (expected: ${s})`));let c=a(i,"bid");return null===c&&(c=a(i,"bundle_id")),e.hasOwnProperty("packageName")&&e.packageName!==c?t(new Error(`Wrong bundle ID: ${e.packageName} (expected: ${c})`)):(r.environment=o,t(null,r))}void 0!==e.secret&&(r.equal(typeof e.secret,"string","payment.secret must be a string"),n.password=e.secret),void 0!==e.excludeOldTransactions&&(r.equal(typeof e.excludeOldTransactions,"boolean","payment.excludeOldTransactions must be a boolean"),n["exclude-old-transactions"]=e.excludeOldTransactions),c("https://buy.itunes.apple.com/verifyReceipt",{json:n},(function(e,t){return e&&21007===e.status?c("https://sandbox.itunes.apple.com/verifyReceipt",{json:n},(function(e,t){i(e,t,"sandbox")})):i(e,t,"production")}))}},144:(e,t,n)=>{const r=n(357),o=n(32),i=n(509),a=n(20);function s(e){let t;return r.equal(typeof e.packageName,"string","Package name must be a string"),r.equal(typeof e.productId,"string","Product ID must be a string"),r.equal(typeof e.receipt,"string","Receipt must be a string"),t="string"==typeof e.keyObject||Buffer.isBuffer(e.keyObject)?JSON.parse(e.keyObject):e.keyObject,r(t,"Google API key object must be provided"),r.equal(typeof t,"object","Google API key object must be an object"),r.equal(typeof t.client_email,"string","Google API client_email must be a string"),r.equal(typeof t.private_key,"string","Google API private_key must be a string"),t}t.verifyPayment=function(e,t){let n;try{n=s(e)}catch(e){return process.nextTick((function(){t(e)}))}o.getToken(n.client_email,n.private_key,i.publisherScope,(function(n,r){if(n)return t(n);let o;o=e.subscription?i.purchasesSubscriptionsGet(e.packageName,e.productId,e.receipt,r):i.purchasesProductsGet(e.packageName,e.productId,e.receipt,r),a.get(o,null,(function(n,r,o){if(n)return t(n);if(200!==r.statusCode)return t({statusCode:r.statusCode,error:o});let i;try{i=function(e,t){const n=JSON.parse(e),r=n.startTimeMillis||n.purchaseTimeMillis,o=r?parseInt(r,10):null,i=n.expiryTimeMillis?parseInt(n.expiryTimeMillis,10):null;return{receipt:n,transactionId:n.orderId,productId:t.productId,purchaseDate:o,expirationDate:i}}(o,e)}catch(e){return t(e)}return t(null,i)}))}))},t.cancelSubscription=function(e,t){let n;try{n=s(e)}catch(e){return process.nextTick((function(){t(e)}))}o.getToken(n.client_email,n.private_key,i.publisherScope,(function(n,r){if(n)return t(n);const o=i.purchasesSubscriptionsCancel(e.packageName,e.productId,e.receipt,r);a.post(o,null,(function(e,n,r){return e?t(e):204!==n.statusCode?t({statusCode:n.statusCode,error:r}):t(null,null)}))}))}},32:(e,t,n)=>{const r=n(9),o=n(509),i=n(20),a={};t.getToken=function(e,t,n,s){if(a.hasOwnProperty(e)&&a[e].expiry>Date.now())return setImmediate(s,null,a[e].token);const c={grant_type:"urn:ietf:params:oauth:grant-type:jwt-bearer",assertion:r.encode({iss:e,scope:n,aud:o.tokenRequest,exp:Math.floor(Date.now()/1e3)+3600,iat:Math.floor(Date.now()/1e3)},t,"RS256")};i.post(o.tokenRequest,{form:c},(function(t,n,r){if(t)return s(t);if(200!==n.statusCode)return s(new Error(`Received ${n.statusCode} status code with body: ${r}`));let o;try{o=JSON.parse(r)}catch(t){return s(t)}return a[e]={token:o.access_token,expiry:1e3*(o.expires_in-60)+Date.now()},s(null,a[e].token)}))}},509:(e,t,n)=>{const r=n(669);t.tokenRequest="https://accounts.google.com/o/oauth2/token",t.publisherScope="https://www.googleapis.com/auth/androidpublisher",t.purchasesProductsGet=function(e,t,n,o){return r.format("https://www.googleapis.com/androidpublisher/v3/applications/%s/purchases/products/%s/tokens/%s?access_token=%s",encodeURIComponent(e),encodeURIComponent(t),encodeURIComponent(n),encodeURIComponent(o))},t.purchasesSubscriptionsGet=function(e,t,n,o){return r.format("https://www.googleapis.com/androidpublisher/v3/applications/%s/purchases/subscriptions/%s/tokens/%s?access_token=%s",encodeURIComponent(e),encodeURIComponent(t),encodeURIComponent(n),encodeURIComponent(o))},t.purchasesSubscriptionsCancel=function(e,t,n,o){return r.format("https://www.googleapis.com/androidpublisher/v3/applications/%s/purchases/subscriptions/%s/tokens/%s:cancel?access_token=%s",encodeURIComponent(e),encodeURIComponent(t),encodeURIComponent(n),encodeURIComponent(o))}},952:(e,t,n)=>{const r=n(20);e.exports=function(e,t,n){(t=t||{}).method="GET",r.request(e,t,null,n)}},20:(e,t,n)=>{t.request=n(614),t.post=n(634),t.get=n(952)},634:(e,t,n)=>{const r=n(20),o=n(191);e.exports=function(e,t,n){t=t||{};let i=null;try{t.form?(i=o.stringify(t.form),t.headers={"content-type":"application/x-www-form-urlencoded","content-length":Buffer.byteLength(i)}):t.json&&(i=JSON.stringify(t.json),t.headers={"content-type":"application/json","content-length":Buffer.byteLength(i)})}catch(e){return process.nextTick((function(){n(e)}))}t.method="POST",r.request(e,t,i,n)}},614:(e,t,n)=>{const r=n(835),o=n(211);e.exports=function(e,t,n,i){t=t||{};const a=r.parse(e);a.hostname&&(t.hostname=a.hostname),a.port&&(t.port=a.port),a.path&&(t.path=a.path);const s=o.request(t,(function(e){e.setEncoding("utf8");let t="";e.on("data",(function(e){t+=e})),e.on("end",(function(){i(null,e,t)}))}));s.on("error",i),s.end(n)}},469:(e,t,n)=>{const r=n(357),o=n(20);t.verifyPayment=function(e,t){try{r.equal(typeof e.devToken,"string","Developer ID must be a string"),r.equal(typeof e.receipt,"string","Receipt must be a string"),r.equal(e.receipt.match(/\w/g).length,32,"Receipt must contain 32 digits"),r.equal(e.receipt.match(/-/g).length,4,"Receipt must contain 4 dashes")}catch(e){return process.nextTick((function(){t(e)}))}const n=`https://apipub.roku.com/listen/transaction-service.svc/validate-transaction/${e.devToken}/${e.receipt}`;o.get(n,{headers:{Accept:"application/json"}},(function(e,n,r){if(e)return t(e);if(200!==n.statusCode)return t(new Error(`Received ${n.statusCode} status code with body: ${r}`));let o=null;try{o=function(e){const t=JSON.parse(e);return t.originalPurchaseDate=new Date(parseInt(t.originalPurchaseDate.substr(6),10)).getTime(),t.purchaseDate=new Date(parseInt(t.purchaseDate.substr(6),10)).getTime(),t.expirationDate=t.expirationDate?new Date(parseInt(t.expirationDate.substr(6),10)).getTime():null,{receipt:t,transactionId:t.transactionId,productId:t.productId,purchaseDate:t.purchaseDate,expirationDate:t.expirationDate}}(r)}catch(e){return t(e)}if(o.receipt.errorMessage)return t(new Error(o.receipt.errorMessage));t(null,o)}))}},357:e=>{e.exports=require("assert")},211:e=>{e.exports=require("https")},9:e=>{e.exports=require("jwt-simple")},191:e=>{e.exports=require("querystring")},835:e=>{e.exports=require("url")},669:e=>{e.exports=require("util")}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r](i,i.exports,n),i.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{const e=require("firebase-admin"),t=require("express");var r=n.n(t);const o=require("mongoose");var i=n.n(o);const a=require("cors");var s=n.n(a),c=[r().json({limit:"50mb"}),r().urlencoded({extended:!0})];const u=function(){function e(e,t,n){void 0===n&&(n=400),this.responseCode=400,this.message=t,this.resultCode=e,this.responseCode=n,this.name="ApiError"}return e.prototype.toResponseData=function(){return{message:this.message,resultCode:this.resultCode}},e}(),l=require("http");var p=n.n(l);function f(e){var t=this;return function(n,r,o){var i,a,s,c;(i=t,a=void 0,s=void 0,c=function(){return function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,(function(t){switch(t.label){case 0:return[4,e(n,r,o)];case 1:return t.sent(),[2]}}))},new(s||(s=Promise))((function(e,t){function n(e){try{o(c.next(e))}catch(e){t(e)}}function r(e){try{o(c.throw(e))}catch(e){t(e)}}function o(t){var o;t.done?e(t.value):(o=t.value,o instanceof s?o:new s((function(e){e(o)}))).then(n,r)}o((c=c.apply(i,a||[])).next())}))).catch((function(e){if("ApiError"===e.name)o(e);else{var t=new u("unknown-error",e.message,500);o(t)}}))}}var d=new o.Schema({firebaseId:{type:String,require:[!0,"Firebase id is required"]},name:{type:String,default:""},email:{type:String,require:[!0,"Email is required"]},phoneNumber:{type:String},apiKey:{type:String,default:""},billingEnabled:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},googleConfig:{type:{},default:null},appleConfig:{type:{secret:{type:String,default:""}},default:{secret:""}},amazonConfig:{type:{userId:{type:String,default:""},secret:{type:String,default:""}},default:{userId:"",secret:""}}}),h=(0,o.model)("user",d);const y=require("uuid-apikey");var b=n.n(y),v=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},m=function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},w=function(){function e(e,t,n){this.message=void 0,this.resultCode="00",this.data={},this.data=e,this.message=n,this.resultCode=t}return e.prototype.toJSON=function(){return{data:this.data,message:this.message,resultCode:this.resultCode}},e}(),g=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},I=function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},k=(0,t.Router)();k.use(function(){var t=this;return f((function(n,r,o){return v(t,void 0,void 0,(function(){var t,r,i=this;return m(this,(function(a){switch(a.label){case 0:return(t=null===(r=n.headers.authorization)||void 0===r?void 0:r.replace("Bearer ","").trim())?[4,e.auth().verifyIdToken(t).then((function(e){return v(i,void 0,void 0,(function(){var t,r,i;return m(this,(function(a){switch(a.label){case 0:return console.log("Token Verified!!!"),t=e.uid,[4,h.findOne({firebaseId:t})];case 1:return r=a.sent(),console.log("user being searched in db"),r?(n.user=r,o()):(console.log("User not found hence creating"),i={firebaseId:t,email:e.email,apiKey:b().create().apiKey},h.create(i,(function(e,t){if(e)throw console.log("Error creating: "+e.message),new u("failed-creating-object",e.message);n.user=t,o()}))),[2]}}))}))})).catch((function(e){throw new u("user-not-found","User not found!",404)}))]:[3,2];case 1:return a.sent(),[3,3];case 2:throw new u("invalid-jwt","Invalid jwt",401);case 3:return[2]}}))}))}))}()),k.put("/",f((function(e,t){return g(void 0,void 0,void 0,(function(){var n,r;return I(this,(function(o){switch(o.label){case 0:Object.assign(e.user,e.body),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,e.user.save()];case 2:return void 0!==(n=o.sent())&&t.send(new w(n).toJSON()),[3,4];case 3:throw r=o.sent(),console.log(r),new u("unknown-error",r.message,400);case 4:return[2]}}))}))}))),k.get("/",f((function(e,t){return g(void 0,void 0,void 0,(function(){return I(this,(function(n){return t.send(new w(e.user).toJSON()),[2]}))}))})));var x=new o.Schema({userId:{type:String,require:[!0,"User Id is required"]},requestsStats:{type:[{date:{type:Number,require:[!0,"Date is required"]},platform:{type:String,require:[!0,"Platform is required"]},appId:{type:String,require:[!0,"AppId is required"]},countForThisCombo:{type:Number}}]}}),S=(0,o.model)("userStatistic",x),_=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a};function q(e,t,n,r,o){return void 0===r&&(r=""),void 0===o&&(o=""),i=this,a=void 0,c=function(){var i,a,s,c,u,l,p,f,d,h,y,b,v,m,w,g,I,k,x,q;return function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,(function(T){switch(T.label){case 0:return[4,S.findOne({userId:e._id})];case 1:if(i=T.sent()){for(a=null==i?void 0:i.requestsStats.filter((function(e){return t===new Date(e.date).getMonth()&&n===new Date(e.date).getFullYear()})),s=0,c=new Map,u=0;u<a.length;u++)l=a[u].countForThisCombo,s+=l,p=a[u].platform,f=a[u].appId,m=p+" "+f,void 0===c.get(m)?c.set(m,l):(d=c.get(m),c.set(m,d+l));h=[];try{for(y=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(c.entries()),b=y.next();!b.done;b=y.next())v=_(b.value,2),m=v[0],w=v[1],g={platform:m.split(" ")[0],appId:m.split(" ")[1],count:w,totalPrice:.3*w},h.push(g)}catch(e){x={error:e}}finally{try{b&&!b.done&&(q=y.return)&&q.call(y)}finally{if(x)throw x.error}}return I={rate:.3,freeAllowance:50,totalCount:s,statistics:h},""!==o&&""===r?(k=I.statistics.filter((function(e){return e.appId===o})),I.statistics=k):""!==r&&""===o?(k=I.statistics.filter((function(e){return e.platform===r})),I.statistics=k):""!==r&&""!==o&&(k=I.statistics.filter((function(e){return e.platform===r&&e.appId===o})),I.statistics=k),[2,I]}return[2,{rate:.3,freeAllowance:50,totalCount:0,statistics:[]}]}}))},new((s=void 0)||(s=Promise))((function(e,t){function n(e){try{o(c.next(e))}catch(e){t(e)}}function r(e){try{o(c.throw(e))}catch(e){t(e)}}function o(t){var o;t.done?e(t.value):(o=t.value,o instanceof s?o:new s((function(e){e(o)}))).then(n,r)}o((c=c.apply(i,a||[])).next())}));var i,a,s,c}var T=n(605),D=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},C=function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},E=(0,t.Router)();E.use(function(){var e=this;return f((function(t,n,r){return o=e,i=void 0,s=function(){var e,n;return function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,(function(o){switch(o.label){case 0:return(e=t.query.apiKey)?[4,h.findOne({apiKey:e})]:[3,2];case 1:if(n=o.sent(),console.log("User: "+n),!n)throw new u("invalid-api-key","User not found. Invalid Api key",404);return t.user=n,r(),[3,3];case 2:throw new u("no-api-key-found","No api key",401);case 3:return[2]}}))},new((a=void 0)||(a=Promise))((function(e,t){function n(e){try{c(s.next(e))}catch(e){t(e)}}function r(e){try{c(s.throw(e))}catch(e){t(e)}}function c(t){var o;t.done?e(t.value):(o=t.value,o instanceof a?o:new a((function(e){e(o)}))).then(n,r)}c((s=s.apply(o,i||[])).next())}));var o,i,a,s}))}()),E.post("/",f((function(e,t,n){return D(void 0,void 0,void 0,(function(){var n,r,o;return C(this,(function(i){switch(i.label){case 0:return n=e.body.platform,r=e.body.paymentData,e.user.disabled?[3,5]:[4,q(e.user,(new Date).getMonth(),(new Date).getFullYear())];case 1:if(o=i.sent().totalCount,e.user.billingEnabled||!(o>=50))return[3,2];throw new u("billing-disabled","Request rejected. You have exceeded the free limit. Kindly enable the billing option to continue using our service!");case 2:return function(e,t,n){var r,o,i,a,s;o=this,i=void 0,s=function(){var o,i,a;return function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((o=(o=a.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,(function(s){switch(s.label){case 0:return[4,S.findOne({userId:e._id})];case 1:return(o=s.sent())?[3,2]:(i=function(e,t,n,r,o){return{userId:e,requestsStats:[{date:Date.now(),platform:t,appId:n,countForThisCombo:1}]}}(e._id,t,n),S.create(i,(function(e,t){if(e)throw new u("failed-creating-object",e.message)})),[3,4]);case 2:return-1==(a=o.requestsStats.findIndex((function(e){return new Date(e.date).toDateString()==(new Date).toDateString()&&e.platform===t&&e.appId===n})))?null===(r=o.requestsStats)||void 0===r||r.push({date:Date.now(),platform:t,appId:n,countForThisCombo:1}):o.requestsStats[a].countForThisCombo=o.requestsStats[a].countForThisCombo+1,[4,o.save()];case 3:s.sent(),s.label=4;case 4:return[2]}}))},new((a=void 0)||(a=Promise))((function(e,t){function n(e){try{c(s.next(e))}catch(e){t(e)}}function r(e){try{c(s.throw(e))}catch(e){t(e)}}function c(t){var o;t.done?e(t.value):(o=t.value,o instanceof a?o:new a((function(e){e(o)}))).then(n,r)}c((s=s.apply(o,i||[])).next())}))}(e.user,n,r.packageName),[4,new Promise((function(e,o){T.verifyPayment(n,r,(function(n,r){return D(void 0,void 0,void 0,(function(){return C(this,(function(i){return r?(e(r),t.send(new w(r))):o(new u("verification-failed",n.message,400)),[2]}))}))}))}))];case 3:i.sent(),i.label=4;case 4:return[3,6];case 5:throw new u("user-disabled","Request rejected. Kindly complete your previous pending payment to continue using our service!");case 6:return[2]}}))}))})));var R=(0,t.Router)();R.use("/auth/profile",k),R.use("/verify",E);var P=r()(),A=n(318);e.initializeApp({credential:e.credential.cert(A)}),P.use(s()()),P.use(c),P.use(R),P.use((function(e,t,n,r){e.constructor===u&&"ApiError"===e.name?n.status(e.responseCode).send(e.toResponseData()):(n.sendStatus(500),console.log(e))}));var B=p().createServer(P);i().connect("mongodb://127.0.0.1:27017/IAPService",{useNewUrlParser:!0,useUnifiedTopology:!0,useCreateIndex:!0}).then((function(){B.listen(process.env.PORT||8080,(function(){console.log("Server Running...")}))}))})()})();