(()=>{"use strict";var e={318:e=>{e.exports=JSON.parse('{"type":"service_account","project_id":"iapservice","private_key_id":"a359781f9938f704c806b45d05b5cbe880899c0a","private_key":"-----BEGIN PRIVATE KEY-----\\nMIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDLrRHcIjVJWAMT\\nCRqZ+ccn+gNv02xT8o+PMVPqBIUefDd7+3Txzz0rQsgcaaFy8qDVm4lZfWS536e8\\nw4B20HiSSacweJrxx4+yPVD7EYXBwtldU9fWrBI+NVJ+BH5U8Dfn3Yd7CElcpjrC\\nWgASvldeeI+rwgLTbmkqoWJOjfYZB670S4aOvpENeEVfv9BFdaae3EsXSrWMwduu\\nZkJa1YnwOH74qYAxs/5oVSTfYkwxZLh0bHdqzM1TR9mZhMIzIqnlX90RBAa7nMc+\\nPOugVsTNbuttN1Z/BsEfApyFaruMGv7SY5a9UH7ayJYPJm6k3//JSzBGkakSoAtL\\nNDMu/dVDAgMBAAECggEAKHatwaoaJAQUOEfqvQReiJam8CR0tQjPdIc8QJW9TJ0o\\n+LywMwoVAO83ik2CAbAqO8W2t8ytoi/Ixzuf3fr0uTtgt8R+I+Kdra940yhcBm6L\\neHsbuk5dIXa+eMKzxnQi5zGfpNW0nW945Pu0YATonqAdCuZ0YUTiJ9IAEdMqPTZq\\nuug76+G4/Zs7oeUfGMI0qLtP18SyzTwA/qTTe+1DbLU6vjr8whlT+UE1/EJeRNdH\\nWEtPPvXeGxgNwMg9tL+fgD7o6WH7Fv+UP6Fq5LG2CEB0YxlUi3quwqDp/J2EDGa+\\np1SB+BB05yDL3B+RQk2eAkjWaBRNhsQiuv74onb6oQKBgQDvYCXL+YxLtt8s9h8M\\nrMkoP1z5O2y9QhwozUgaUuIwXhzxObYYHUxDE+5kAncTjBRHeowluype6WAhnSWM\\nj6H5oTsJ7C66aKus8rNjgv730RUuSnnEz+aFmIrkF2wzlvMdli3KzF/yQ0i+0HNg\\nciSKKLQyaZxUBLOmZk4bGgmCBQKBgQDZ0jigoGkmcVWDHbe1t6K2oJ5f4FbhXfCH\\nLXMN+9L1phJItBA2MgO6plRdWBM0GYagVKmq6D1EyjTvQlRiw2hhnttEE7WsGSlZ\\n277OOjHq1V7qwq1f4kMv3AsYWbZ566m/I8RcP9rSwRIle1k2RaFDc6AuDnQU5U7p\\nMpHee600pwKBgQCM5Wv57q3clwwv28KU5FMWxI0GCitMDtCiV4o8LFMEozCn8A81\\njHEp/l5QMX9DWy1IkWJShyM+cGFsB6JlZNmzJGqqwYETqa57AvQB+8X1ufScpauc\\n475NHmeKMBs5Fn2NCat0de13nJEB95Ihz62gQKsoDS+96HKR3B/XJfE4vQKBgQCv\\nquDMelITFNf4FGFyhhUN4F+Zxx2KR+6Rtk/R+UPbpQGd7MoeSxvCzh2/4iYqoGN4\\nro7fLMkszz79rqrLs/hcsnb3YkXj867rr1Mkkr5rO4V/I14btCinUnkIPGHz1eFi\\nK4BTPZRG4Dq4S9BY+rLh6UBHpJRtvbl0TLpjia7YhQKBgQCBm55LBp0MpqvUgJcl\\nSy7OWDqg6PvGsuTdFV3jIzN78XSBkfI0RyPMygT224JDmnRYabcmIcS/bA4HnswT\\nfsTJG0/3RoDfr/fV7/FxsM+F10kh2YiLhmd0rlj2FNDJwaiJrTbsaymYutmmEJBO\\n7XZjJdiPbcFeasicUoB1wICscQ==\\n-----END PRIVATE KEY-----\\n","client_email":"firebase-adminsdk-q0hwn@iapservice.iam.gserviceaccount.com","client_id":"100681325628266909783","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://oauth2.googleapis.com/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_x509_cert_url":"https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-q0hwn%40iapservice.iam.gserviceaccount.com"}')},26:e=>{e.exports=require("iap")}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var a=t[r]={exports:{}};return e[r](a,a.exports,n),a.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{const e=require("firebase-admin"),t=require("express");var r=n.n(t);const o=require("mongoose");var a=n.n(o);const i=require("cors");var u=n.n(i),s=[r().json({limit:"50mb"}),r().urlencoded({extended:!0})];const l=function(){function e(e,t,n){void 0===n&&(n=400),this.responseCode=400,this.message=t,this.resultCode=e,this.responseCode=n,this.name="ApiError"}return e.prototype.toResponseData=function(){return{message:this.message,resultCode:this.resultCode}},e}(),c=require("http");var f=n.n(c);function p(e){var t=this;return function(n,r,o){var a,i,u,s;(a=t,i=void 0,u=void 0,s=function(){return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(a){return function(u){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}(this,(function(t){switch(t.label){case 0:return[4,e(n,r,o)];case 1:return t.sent(),[2]}}))},new(u||(u=Promise))((function(e,t){function n(e){try{o(s.next(e))}catch(e){t(e)}}function r(e){try{o(s.throw(e))}catch(e){t(e)}}function o(t){var o;t.done?e(t.value):(o=t.value,o instanceof u?o:new u((function(e){e(o)}))).then(n,r)}o((s=s.apply(a,i||[])).next())}))).catch((function(e){if("ApiError"===e.name)o(e);else{var t=new l("unknown-error",e.message,500);o(t)}}))}}var d=new o.Schema({firebaseId:{type:String,require:[!0,"Firebase id is required"]},name:{type:String,default:""},email:{type:String,require:[!0,"Email is required"]},phoneNumber:{type:String,unique:!0,default:""},apiKey:{type:String,default:""},billingEnabled:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},googleConfig:{type:{},default:null},appleConfig:{type:{secret:{type:String,default:""}},default:{secret:""}},amazonConfig:{type:{userId:{type:String,default:""},secret:{type:String,default:""}},default:{userId:"",secret:""}}}),h=(0,o.model)("user",d);const y=require("uuid-apikey");var b=n.n(y),v=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{s(r.next(e))}catch(e){a(e)}}function u(e){try{s(r.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,u)}s((r=r.apply(e,t||[])).next())}))},w=function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(a){return function(u){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}},g=function(){function e(e,t,n){this.message="",this.resultCode="00",this.data={},this.data=e,this.message=n,this.resultCode=t}return e.prototype.toJSON=function(){return{data:this.data,message:this.message,resultCode:this.resultCode}},e}(),m=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{s(r.next(e))}catch(e){a(e)}}function u(e){try{s(r.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,u)}s((r=r.apply(e,t||[])).next())}))},S=function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(a){return function(u){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}},x=(0,t.Router)();x.use(function(){var t=this;return p((function(n,r,o){return v(t,void 0,void 0,(function(){var t,r,a=this;return w(this,(function(i){switch(i.label){case 0:return(t=null===(r=n.headers.authorization)||void 0===r?void 0:r.replace("Bearer ","").trim())?[4,e.auth().verifyIdToken(t).then((function(e){return v(a,void 0,void 0,(function(){var t,r,a;return w(this,(function(i){switch(i.label){case 0:return t=e.uid,[4,h.findOne({firebaseId:t})];case 1:return(r=i.sent())?(n.user=r,o()):(console.log("User not found hence creating"),a={firebaseId:t,email:e.email,apiKey:b().create().apiKey},h.create(a,(function(e,t){if(e)throw console.log("Error creating: "+e.message),new l("failed-creating-object",e.message);n.user=t,o()}))),[2]}}))}))})).catch((function(e){throw new l("user-not-found","User not found!",404)}))]:[3,2];case 1:return i.sent(),[3,3];case 2:throw new l("invalid-jwt","Invalid jwt",401);case 3:return[2]}}))}))}))}()),x.post("/",p((function(e,t){return m(void 0,void 0,void 0,(function(){var n,r;return S(this,(function(o){switch(o.label){case 0:Object.assign(e.user,e.body),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,e.user.save()];case 2:return void 0!==(n=o.sent())&&t.send(new g(n).toJSON()),[3,4];case 3:throw r=o.sent(),console.log(r),new l("unknown-error",r.message,400);case 4:return[2]}}))}))}))),x.get("/",p((function(e,t){return m(void 0,void 0,void 0,(function(){return S(this,(function(n){return t.send(new g(e.user).toJSON()),[2]}))}))})));var k=new o.Schema({userId:{type:String,require:[!0,"User Id is required"]},requestsStats:{type:[{date:{type:Number,require:[!0,"Date is required"]},platform:{type:String,require:[!0,"Platform is required"]},appId:{type:String,require:[!0,"AppId is required"]},countForThisCombo:{type:Number}}]}}),q=(0,o.model)("userStatistic",k),I=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,a=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(r=a.next()).done;)i.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=a.return)&&n.call(a)}finally{if(o)throw o.error}}return i};function D(e,t,n,r,o){return void 0===r&&(r=""),void 0===o&&(o=""),a=this,i=void 0,s=function(){var a,i,u,s,l,c,f,p,d,h,y,b,v,w,g,m,S,x,k,D;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(a){return function(u){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}(this,(function(E){switch(E.label){case 0:return console.log(e._id+" "+t+" +"),[4,q.findOne({userId:e._id})];case 1:if(a=E.sent(),console.log(a),a){for(i=null==a?void 0:a.requestsStats.filter((function(e){return console.log(new Date(e.date).getMonth()+" *-*-*-"),t===new Date(e.date).getMonth()&&n===new Date(e.date).getFullYear()})),console.log(JSON.stringify(i)+" array"),u=0,s=new Map,l=0;l<i.length;l++)c=i[l].countForThisCombo,u+=c,f=i[l].platform,p=i[l].appId,w=f+" "+p,void 0===s.get(w)?s.set(w,c):(d=s.get(w),s.set(w,d+c));h=[];try{for(y=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(s.entries()),b=y.next();!b.done;b=y.next())v=I(b.value,2),w=v[0],g=v[1],m={platform:w.split(" ")[0],appId:w.split(" ")[1],count:g},h.push(m)}catch(e){k={error:e}}finally{try{b&&!b.done&&(D=y.return)&&D.call(y)}finally{if(k)throw k.error}}return S={billedRequests:Math.max(0,u-50),amountPayable:.5*Math.max(0,u-50),totalCount:u,statistics:h},""!==o&&""===r?(x=S.statistics.filter((function(e){return e.appId===o})),S.statistics=x):""!==r&&""===o?(x=S.statistics.filter((function(e){return e.platform===r})),S.statistics=x):""!==r&&""!==o&&(x=S.statistics.filter((function(e){return e.platform===r&&e.appId===o})),S.statistics=x),[2,S]}return console.log("Empty object"),[2,{billedRequests:0,amountPayable:0,totalCount:0,statistics:[]}]}}))},new((u=void 0)||(u=Promise))((function(e,t){function n(e){try{o(s.next(e))}catch(e){t(e)}}function r(e){try{o(s.throw(e))}catch(e){t(e)}}function o(t){var o;t.done?e(t.value):(o=t.value,o instanceof u?o:new u((function(e){e(o)}))).then(n,r)}o((s=s.apply(a,i||[])).next())}));var a,i,u,s}var E=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{s(r.next(e))}catch(e){a(e)}}function u(e){try{s(r.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,u)}s((r=r.apply(e,t||[])).next())}))},B=function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(a){return function(u){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}},C=n(26),M=(0,t.Router)();M.use(function(){var e=this;return p((function(t,n,r){return o=e,a=void 0,u=function(){var e,n;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(a){return function(u){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}(this,(function(o){switch(o.label){case 0:return(e=t.query.apiKey)?[4,h.findOne({apiKey:e})]:[3,2];case 1:if(n=o.sent(),console.log("User: "+n),!n)throw new l("invalid-api-key","User not found. Invalid Api key",404);return t.user=n,r(),[3,3];case 2:throw new l("no-api-key-found","No api key",401);case 3:return[2]}}))},new((i=void 0)||(i=Promise))((function(e,t){function n(e){try{s(u.next(e))}catch(e){t(e)}}function r(e){try{s(u.throw(e))}catch(e){t(e)}}function s(t){var o;t.done?e(t.value):(o=t.value,o instanceof i?o:new i((function(e){e(o)}))).then(n,r)}s((u=u.apply(o,a||[])).next())}));var o,a,i,u}))}()),M.post("/",p((function(e,t,n){return E(void 0,void 0,void 0,(function(){var n,r,o;return B(this,(function(a){switch(a.label){case 0:return n=e.body.platform,r=e.body.paymentData,e.user.disabled?[3,5]:[4,D(e.user,(new Date).getMonth(),(new Date).getFullYear())];case 1:if(o=a.sent().totalCount,e.user.billingEnabled||!(o>=50))return[3,2];throw new l("billing-disabled","Request rejected. You have exceeded the free limit. Kindly enable the billing option to continue using our service!");case 2:return function(e,t,n){var r,o,a,i,u;o=this,a=void 0,u=function(){var o,a,i;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(a){return function(u){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}(this,(function(u){switch(u.label){case 0:return[4,q.findOne({userId:e._id})];case 1:return(o=u.sent())?[3,2]:(a=function(e,t,n,r,o){return{userId:e,requestsStats:[{date:Date.now(),platform:t,appId:n,countForThisCombo:1}]}}(e._id,t,n),q.create(a,(function(e,t){if(e)throw new l("failed-creating-object",e.message)})),[3,4]);case 2:return-1==(i=o.requestsStats.findIndex((function(e){return new Date(e.date).toDateString()==(new Date).toDateString()&&e.platform===t&&e.appId===n})))?null===(r=o.requestsStats)||void 0===r||r.push({date:Date.now(),platform:t,appId:n,countForThisCombo:1}):o.requestsStats[i].countForThisCombo=o.requestsStats[i].countForThisCombo+1,[4,o.save()];case 3:u.sent(),u.label=4;case 4:return[2]}}))},new((i=void 0)||(i=Promise))((function(e,t){function n(e){try{s(u.next(e))}catch(e){t(e)}}function r(e){try{s(u.throw(e))}catch(e){t(e)}}function s(t){var o;t.done?e(t.value):(o=t.value,o instanceof i?o:new i((function(e){e(o)}))).then(n,r)}s((u=u.apply(o,a||[])).next())}))}(e.user,n,r.packageName),[4,new Promise((function(e,o){C.verifyPayment(n,r,(function(n,r){return E(void 0,void 0,void 0,(function(){return B(this,(function(a){return r?(e(r),t.send(new g(r))):o(new l("verification-failed",n.message,400)),[2]}))}))}))}))];case 3:a.sent(),a.label=4;case 4:return[3,6];case 5:throw new l("user-disabled","Request rejected. Kindly complete your previous pending payment to continue using our service!");case 6:return[2]}}))}))})));var T=(0,t.Router)();T.use("/auth/profile",x),T.use("/verify",M);const A=require("cron");function P(e,t,n,r){console.log("Sending mail")}function J(e){console.log("Generating pdf")}var N=new A.CronJob("* * * * *",(function(){return e=this,t=void 0,r=function(){var e,t;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(a){return function(u){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}(this,(function(n){switch(n.label){case 0:return[4,h.find({})];case 1:e=n.sent(),t=0,n.label=2;case 2:return t<e.length?0!==(new Date).getMonth()?[3,4]:[4,D(e[t],11,(new Date).getFullYear()-1)]:[3,8];case 3:return n.sent(),[3,6];case 4:return[4,D(e[t],(new Date).getMonth()-1,(new Date).getFullYear())];case 5:n.sent(),n.label=6;case 6:J(),P(0,e[t].email),n.label=7;case 7:return t++,[3,2];case 8:return[2]}}))},new((n=void 0)||(n=Promise))((function(o,a){function i(e){try{s(r.next(e))}catch(e){a(e)}}function u(e){try{s(r.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,u)}s((r=r.apply(e,t||[])).next())}));var e,t,n,r}),null,!0,"Asia/Kolkata"),R=new o.Schema({userId:{type:String,require:[!0]},price:{type:Number,require:[!0]},currencyCode:{type:String,require:[!0]},orderId:{type:String,require:[!0]},forBillDate:{type:Number,require:[!0]}}),F=(0,o.model)("transaction",R),G=function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(a){return function(u){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}},Y=new A.CronJob("* * * * *",(function(){return e=this,t=void 0,r=function(){var e,t,n,r;return G(this,(function(o){switch(o.label){case 0:return[4,h.find({})];case 1:e=o.sent(),t=function(t){var r,o,a;return G(this,(function(i){switch(i.label){case 0:return[4,F.find({userId:e[t]._id})];case 1:return r=i.sent(),console.log(JSON.stringify(r)),console.log(typeof r),0!==(new Date).getMonth()?[3,3]:[4,D(e[t],11,(new Date).getFullYear()-1)];case 2:return n=i.sent(),[3,5];case 3:return[4,D(e[t],(new Date).getMonth()-1,(new Date).getFullYear())];case 4:n=i.sent(),i.label=5;case 5:return console.log(JSON.stringify(n)),0!==n.amountPayable?[3,6]:(console.log("ampunt=0"),[2,"continue"]);case 6:return void 0===r||r&&0===r.length?(console.log("transactions === undefined"),J(),P(0,e[t].email),e[t].disabled=!0,[4,e[t].save()]):[3,8];case 7:return i.sent(),[3,10];case 8:return console.log("IDK"),(o=new Date).setDate(o.getDate()-7),a=r.find((function(e){return new Date(e.forBillDate).toDateString()===o.toDateString()})),console.log(a+"****"),a?[3,10]:(console.log("*********"),J(),P(0,e[t].email),e[t].disabled=!0,[4,e[t].save()]);case 9:i.sent(),i.label=10;case 10:return[2]}}))},r=0,o.label=2;case 2:return r<e.length?[5,t(r)]:[3,5];case 3:o.sent(),o.label=4;case 4:return r++,[3,2];case 5:return[2]}}))},new((n=void 0)||(n=Promise))((function(o,a){function i(e){try{s(r.next(e))}catch(e){a(e)}}function u(e){try{s(r.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,u)}s((r=r.apply(e,t||[])).next())}));var e,t,n,r}),null,!0,"Asia/Kolkata"),K=r()(),O=n(318);N.start(),Y.start(),e.initializeApp({credential:e.credential.cert(O)}),K.use(u()()),K.use(s),K.use(T),K.use((function(e,t,n,r){e.constructor===l&&"ApiError"===e.name?n.status(e.responseCode).send(e.toResponseData()):(n.sendStatus(500),console.log(e))}));var U=f().createServer(K);a().connect("mongodb://127.0.0.1:27017/IAPService",{useNewUrlParser:!0,useUnifiedTopology:!0,useCreateIndex:!0}).then((function(){U.listen(process.env.PORT||8080,(function(){console.log("Server Running...")}))}))})()})();