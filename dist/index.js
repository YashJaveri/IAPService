(()=>{"use strict";var e={318:e=>{e.exports=JSON.parse('{"type":"service_account","project_id":"iapservice","private_key_id":"a359781f9938f704c806b45d05b5cbe880899c0a","private_key":"-----BEGIN PRIVATE KEY-----\\nMIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQDLrRHcIjVJWAMT\\nCRqZ+ccn+gNv02xT8o+PMVPqBIUefDd7+3Txzz0rQsgcaaFy8qDVm4lZfWS536e8\\nw4B20HiSSacweJrxx4+yPVD7EYXBwtldU9fWrBI+NVJ+BH5U8Dfn3Yd7CElcpjrC\\nWgASvldeeI+rwgLTbmkqoWJOjfYZB670S4aOvpENeEVfv9BFdaae3EsXSrWMwduu\\nZkJa1YnwOH74qYAxs/5oVSTfYkwxZLh0bHdqzM1TR9mZhMIzIqnlX90RBAa7nMc+\\nPOugVsTNbuttN1Z/BsEfApyFaruMGv7SY5a9UH7ayJYPJm6k3//JSzBGkakSoAtL\\nNDMu/dVDAgMBAAECggEAKHatwaoaJAQUOEfqvQReiJam8CR0tQjPdIc8QJW9TJ0o\\n+LywMwoVAO83ik2CAbAqO8W2t8ytoi/Ixzuf3fr0uTtgt8R+I+Kdra940yhcBm6L\\neHsbuk5dIXa+eMKzxnQi5zGfpNW0nW945Pu0YATonqAdCuZ0YUTiJ9IAEdMqPTZq\\nuug76+G4/Zs7oeUfGMI0qLtP18SyzTwA/qTTe+1DbLU6vjr8whlT+UE1/EJeRNdH\\nWEtPPvXeGxgNwMg9tL+fgD7o6WH7Fv+UP6Fq5LG2CEB0YxlUi3quwqDp/J2EDGa+\\np1SB+BB05yDL3B+RQk2eAkjWaBRNhsQiuv74onb6oQKBgQDvYCXL+YxLtt8s9h8M\\nrMkoP1z5O2y9QhwozUgaUuIwXhzxObYYHUxDE+5kAncTjBRHeowluype6WAhnSWM\\nj6H5oTsJ7C66aKus8rNjgv730RUuSnnEz+aFmIrkF2wzlvMdli3KzF/yQ0i+0HNg\\nciSKKLQyaZxUBLOmZk4bGgmCBQKBgQDZ0jigoGkmcVWDHbe1t6K2oJ5f4FbhXfCH\\nLXMN+9L1phJItBA2MgO6plRdWBM0GYagVKmq6D1EyjTvQlRiw2hhnttEE7WsGSlZ\\n277OOjHq1V7qwq1f4kMv3AsYWbZ566m/I8RcP9rSwRIle1k2RaFDc6AuDnQU5U7p\\nMpHee600pwKBgQCM5Wv57q3clwwv28KU5FMWxI0GCitMDtCiV4o8LFMEozCn8A81\\njHEp/l5QMX9DWy1IkWJShyM+cGFsB6JlZNmzJGqqwYETqa57AvQB+8X1ufScpauc\\n475NHmeKMBs5Fn2NCat0de13nJEB95Ihz62gQKsoDS+96HKR3B/XJfE4vQKBgQCv\\nquDMelITFNf4FGFyhhUN4F+Zxx2KR+6Rtk/R+UPbpQGd7MoeSxvCzh2/4iYqoGN4\\nro7fLMkszz79rqrLs/hcsnb3YkXj867rr1Mkkr5rO4V/I14btCinUnkIPGHz1eFi\\nK4BTPZRG4Dq4S9BY+rLh6UBHpJRtvbl0TLpjia7YhQKBgQCBm55LBp0MpqvUgJcl\\nSy7OWDqg6PvGsuTdFV3jIzN78XSBkfI0RyPMygT224JDmnRYabcmIcS/bA4HnswT\\nfsTJG0/3RoDfr/fV7/FxsM+F10kh2YiLhmd0rlj2FNDJwaiJrTbsaymYutmmEJBO\\n7XZjJdiPbcFeasicUoB1wICscQ==\\n-----END PRIVATE KEY-----\\n","client_email":"firebase-adminsdk-q0hwn@iapservice.iam.gserviceaccount.com","client_id":"100681325628266909783","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://oauth2.googleapis.com/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_x509_cert_url":"https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-q0hwn%40iapservice.iam.gserviceaccount.com"}')},605:(e,t,n)=>{const r={amazon:n(755),apple:n(532),google:n(144),roku:n(469)};t.verifyPayment=function(e,t,n){function o(e){process.nextTick((function(){n(e)}))}if(!t)return o(new Error("No payment given"));const a=r[e];if(!a)return o(new Error(`Platform ${e} not recognized`));a.verifyPayment(t,(function(t,r){if(t)return n(t);r.platform=e,n(null,r)}))},t.cancelSubscription=function(e,t,n){function o(e){process.nextTick((function(){n(e)}))}if(!t)return o(new Error("No payment given"));const a=r[e];return a?a.cancelSubscription?void a.cancelSubscription(t,(function(e,t){if(e)return n(e);n(null,t)})):o(new Error(`Platform ${e} does not have cancelSubscription method`)):o(new Error(`Platform ${e} not recognized`))}},755:(e,t,n)=>{const r=n(357),o=n(20);t.verifyPayment=function(e,t){try{r.equal(typeof e.secret,"string","Shared secret must be a string"),r.equal(typeof e.userId,"string","User ID must be a string"),r.equal(typeof e.receipt,"string","Receipt must be a string")}catch(e){return process.nextTick((function(){t(e)}))}const n=`${"https://appstore-sdk.amazon.com/version/1.0/verifyReceiptId/developer/"+e.secret}/user/${e.userId}/receiptId/${e.receipt}`;o.get(n,null,(function(e,n,r){if(e)return t(e);let o=null;try{o=function(e){const t=JSON.parse(e),n=t.purchaseDate?parseInt(t.purchaseDate,10):null;let r=null;return t.cancelDate?r=parseInt(t.cancelDate,10):t.renewalDate&&(r=parseInt(t.renewalDate,10)),{receipt:t,transactionId:t.receiptId,productId:t.productId,purchaseDate:n,expirationDate:r}}(r)}catch(e){return t(e)}return 400===n.statusCode?t(new Error("receiptId is invalid, or no transaction was found for this receiptId")):496===n.statusCode?t(new Error("Invalid sharedSecret")):497===n.statusCode?t(new Error("Invalid User ID")):500===n.statusCode?t(new Error("There was an Internal Servor Error")):200!==n.statusCode?t(new Error("Unknown operation exception")):void t(null,o)}))}},532:(e,t,n)=>{const r=n(357),o=n(20),a={21e3:"The App Store could not read the JSON object you provided.",21002:"The data in the receipt-data property was malformed or missing.",21003:"The receipt could not be authenticated.",21004:"The shared secret you provided does not match the shared secret on file for your account.",21005:"The receipt server is not currently available.",21006:"This receipt is valid but the subscription has expired. When this status code is returned to your server, the receipt data is also decoded and returned as part of the response.",21007:"This receipt is from the test environment, but it was sent to the production service for verification. Send it to the test environment service instead.",21008:"This receipt is from the production receipt, but it was sent to the test environment service for verification. Send it to the production environment service instead.",21009:"Internal data access error. Try again later.",21010:"The user account cannot be found or has been deleted."};function i(e,t){if(e.hasOwnProperty(t))return e[t];if(e.hasOwnProperty("in_app")&&e.in_app[0]){const n=e.in_app.reduce(((e,t)=>e.purchase_date_ms>t.purchase_date_ms?e:t));return n.hasOwnProperty(t)?n[t]:null}return null}function s(e){return e?parseInt(e,10):null}function c(e,t,n){o.post(e,t,(function(e,t,r){if(e)return n(e);if(200!==t.statusCode)return n({statusCode:t.statusCode,error:r});let o;try{o=function(e){e=JSON.parse(e);const t=parseInt(e.status,10);let n=null;if(0!==t&&21006!==t){const e=new Error(a[t]||`Unknown status code: ${t}`);throw e.status=t,e}let r=i(e.receipt,"product_id"),o=i(e.receipt,"transaction_id"),c=s(i(e.receipt,"purchase_date_ms")),l=s(i(e.receipt,"expires_date_ms")||i(e.receipt,"expires_date"));const u=i(e,"latest_expired_receipt_info"),p=i(e,"pending_renewal_info");if(e.hasOwnProperty("latest_receipt_info"))if(Array.isArray(e.latest_receipt_info)&&e.latest_receipt_info.length>0){n=e.latest_receipt_info.sort((function(e,t){return parseInt(e.transaction_id,10)-parseInt(t.transaction_id,10)}));const t=n[n.length-1];r=t.product_id,o=t.transaction_id,c=s(t.purchase_date_ms),l=s(t.expires_date_ms||t.expires_date)}else e.latest_receipt_info&&e.latest_receipt_info.transaction_id&&(n=[e.latest_receipt_info],r=e.latest_receipt_info.product_id,o=e.latest_receipt_info.transaction_id,c=s(e.latest_receipt_info.purchase_date_ms),l=s(e.latest_receipt_info.expires_date_ms||e.latest_receipt_info.expires_date));return u&&u.cancellation_date_ms&&(l=s(u.cancellation_date_ms)),{receipt:e.receipt,latestReceiptInfo:n,latestExpiredReceiptInfo:u,productId:r,transactionId:o,purchaseDate:c,expirationDate:l,pendingRenewalInfo:p}}(r)}catch(e){return n(e)}n(null,o)}))}t.verifyPayment=function(e,t){const n={};try{r.equal(typeof e.receipt,"string","Receipt must be a string"),o=e.receipt,Boolean(o.match(/^[a-zA-Z0-9/+]+={0,2}$/))?n["receipt-data"]=e.receipt:n["receipt-data"]=Buffer.from(e.receipt,"utf8").toString("base64")}catch(e){return process.nextTick((function(){t(e)}))}var o;function a(n,r,o){if(n)return t(n);const a=r.receipt,s=i(a,"product_id");if(e.hasOwnProperty("productId")&&e.productId!==s)return t(new Error(`Wrong product ID: ${e.productId} (expected: ${s})`));let c=i(a,"bid");return null===c&&(c=i(a,"bundle_id")),e.hasOwnProperty("packageName")&&e.packageName!==c?t(new Error(`Wrong bundle ID: ${e.packageName} (expected: ${c})`)):(r.environment=o,t(null,r))}void 0!==e.secret&&(r.equal(typeof e.secret,"string","payment.secret must be a string"),n.password=e.secret),void 0!==e.excludeOldTransactions&&(r.equal(typeof e.excludeOldTransactions,"boolean","payment.excludeOldTransactions must be a boolean"),n["exclude-old-transactions"]=e.excludeOldTransactions),c("https://buy.itunes.apple.com/verifyReceipt",{json:n},(function(e,t){return e&&21007===e.status?c("https://sandbox.itunes.apple.com/verifyReceipt",{json:n},(function(e,t){a(e,t,"sandbox")})):a(e,t,"production")}))}},144:(e,t,n)=>{const r=n(357),o=n(32),a=n(509),i=n(20);function s(e){let t;return r.equal(typeof e.packageName,"string","Package name must be a string"),r.equal(typeof e.productId,"string","Product ID must be a string"),r.equal(typeof e.receipt,"string","Receipt must be a string"),t="string"==typeof e.keyObject||Buffer.isBuffer(e.keyObject)?JSON.parse(e.keyObject):e.keyObject,r(t,"Google API key object must be provided"),r.equal(typeof t,"object","Google API key object must be an object"),r.equal(typeof t.client_email,"string","Google API client_email must be a string"),r.equal(typeof t.private_key,"string","Google API private_key must be a string"),t}t.verifyPayment=function(e,t){let n;try{n=s(e)}catch(e){return process.nextTick((function(){t(e)}))}o.getToken(n.client_email,n.private_key,a.publisherScope,(function(n,r){if(n)return t(n);let o;o=e.subscription?a.purchasesSubscriptionsGet(e.packageName,e.productId,e.receipt,r):a.purchasesProductsGet(e.packageName,e.productId,e.receipt,r),i.get(o,null,(function(n,r,o){if(n)return t(n);if(200!==r.statusCode)return t({statusCode:r.statusCode,error:o});let a;try{a=function(e,t){const n=JSON.parse(e),r=n.startTimeMillis||n.purchaseTimeMillis,o=r?parseInt(r,10):null,a=n.expiryTimeMillis?parseInt(n.expiryTimeMillis,10):null;return{receipt:n,transactionId:n.orderId,productId:t.productId,purchaseDate:o,expirationDate:a}}(o,e)}catch(e){return t(e)}return t(null,a)}))}))},t.cancelSubscription=function(e,t){let n;try{n=s(e)}catch(e){return process.nextTick((function(){t(e)}))}o.getToken(n.client_email,n.private_key,a.publisherScope,(function(n,r){if(n)return t(n);const o=a.purchasesSubscriptionsCancel(e.packageName,e.productId,e.receipt,r);i.post(o,null,(function(e,n,r){return e?t(e):204!==n.statusCode?t({statusCode:n.statusCode,error:r}):t(null,null)}))}))}},32:(e,t,n)=>{const r=n(9),o=n(509),a=n(20),i={};t.getToken=function(e,t,n,s){if(i.hasOwnProperty(e)&&i[e].expiry>Date.now())return setImmediate(s,null,i[e].token);const c={grant_type:"urn:ietf:params:oauth:grant-type:jwt-bearer",assertion:r.encode({iss:e,scope:n,aud:o.tokenRequest,exp:Math.floor(Date.now()/1e3)+3600,iat:Math.floor(Date.now()/1e3)},t,"RS256")};a.post(o.tokenRequest,{form:c},(function(t,n,r){if(t)return s(t);if(200!==n.statusCode)return s(new Error(`Received ${n.statusCode} status code with body: ${r}`));let o;try{o=JSON.parse(r)}catch(t){return s(t)}return i[e]={token:o.access_token,expiry:1e3*(o.expires_in-60)+Date.now()},s(null,i[e].token)}))}},509:(e,t,n)=>{const r=n(669);t.tokenRequest="https://accounts.google.com/o/oauth2/token",t.publisherScope="https://www.googleapis.com/auth/androidpublisher",t.purchasesProductsGet=function(e,t,n,o){return r.format("https://www.googleapis.com/androidpublisher/v3/applications/%s/purchases/products/%s/tokens/%s?access_token=%s",encodeURIComponent(e),encodeURIComponent(t),encodeURIComponent(n),encodeURIComponent(o))},t.purchasesSubscriptionsGet=function(e,t,n,o){return r.format("https://www.googleapis.com/androidpublisher/v3/applications/%s/purchases/subscriptions/%s/tokens/%s?access_token=%s",encodeURIComponent(e),encodeURIComponent(t),encodeURIComponent(n),encodeURIComponent(o))},t.purchasesSubscriptionsCancel=function(e,t,n,o){return r.format("https://www.googleapis.com/androidpublisher/v3/applications/%s/purchases/subscriptions/%s/tokens/%s:cancel?access_token=%s",encodeURIComponent(e),encodeURIComponent(t),encodeURIComponent(n),encodeURIComponent(o))}},952:(e,t,n)=>{const r=n(20);e.exports=function(e,t,n){(t=t||{}).method="GET",r.request(e,t,null,n)}},20:(e,t,n)=>{t.request=n(614),t.post=n(634),t.get=n(952)},634:(e,t,n)=>{const r=n(20),o=n(191);e.exports=function(e,t,n){t=t||{};let a=null;try{t.form?(a=o.stringify(t.form),t.headers={"content-type":"application/x-www-form-urlencoded","content-length":Buffer.byteLength(a)}):t.json&&(a=JSON.stringify(t.json),t.headers={"content-type":"application/json","content-length":Buffer.byteLength(a)})}catch(e){return process.nextTick((function(){n(e)}))}t.method="POST",r.request(e,t,a,n)}},614:(e,t,n)=>{const r=n(835),o=n(211);e.exports=function(e,t,n,a){t=t||{};const i=r.parse(e);i.hostname&&(t.hostname=i.hostname),i.port&&(t.port=i.port),i.path&&(t.path=i.path);const s=o.request(t,(function(e){e.setEncoding("utf8");let t="";e.on("data",(function(e){t+=e})),e.on("end",(function(){a(null,e,t)}))}));s.on("error",a),s.end(n)}},469:(e,t,n)=>{const r=n(357),o=n(20);t.verifyPayment=function(e,t){try{r.equal(typeof e.devToken,"string","Developer ID must be a string"),r.equal(typeof e.receipt,"string","Receipt must be a string"),r.equal(e.receipt.match(/\w/g).length,32,"Receipt must contain 32 digits"),r.equal(e.receipt.match(/-/g).length,4,"Receipt must contain 4 dashes")}catch(e){return process.nextTick((function(){t(e)}))}const n=`https://apipub.roku.com/listen/transaction-service.svc/validate-transaction/${e.devToken}/${e.receipt}`;o.get(n,{headers:{Accept:"application/json"}},(function(e,n,r){if(e)return t(e);if(200!==n.statusCode)return t(new Error(`Received ${n.statusCode} status code with body: ${r}`));let o=null;try{o=function(e){const t=JSON.parse(e);return t.originalPurchaseDate=new Date(parseInt(t.originalPurchaseDate.substr(6),10)).getTime(),t.purchaseDate=new Date(parseInt(t.purchaseDate.substr(6),10)).getTime(),t.expirationDate=t.expirationDate?new Date(parseInt(t.expirationDate.substr(6),10)).getTime():null,{receipt:t,transactionId:t.transactionId,productId:t.productId,purchaseDate:t.purchaseDate,expirationDate:t.expirationDate}}(r)}catch(e){return t(e)}if(o.receipt.errorMessage)return t(new Error(o.receipt.errorMessage));t(null,o)}))}},357:e=>{e.exports=require("assert")},747:e=>{e.exports=require("fs")},778:e=>{e.exports=require("handlebars")},211:e=>{e.exports=require("https")},9:e=>{e.exports=require("jwt-simple")},123:e=>{e.exports=require("nodemailer")},487:e=>{e.exports=require("pdf-creator-node")},191:e=>{e.exports=require("querystring")},835:e=>{e.exports=require("url")},669:e=>{e.exports=require("util")}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var a=t[r]={exports:{}};return e[r](a,a.exports,n),a.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{const e=require("firebase-admin"),t=require("express");var r=n.n(t);const o=require("mongoose");var a=n.n(o);const i=require("cors");var s=n.n(i),c=[r().json({limit:"50mb"}),r().urlencoded({extended:!0})];const l=function(){function e(e,t,n){void 0===n&&(n=400),this.responseCode=400,this.message=t,this.resultCode=e,this.responseCode=n,this.name="ApiError"}return e.prototype.toResponseData=function(){return{message:this.message,resultCode:this.resultCode}},e}(),u=require("http");var p=n.n(u);function f(e){var t=this;return function(n,r,o){var a,i,s,c;(a=t,i=void 0,s=void 0,c=function(){return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}(this,(function(t){switch(t.label){case 0:return[4,e(n,r,o)];case 1:return t.sent(),[2]}}))},new(s||(s=Promise))((function(e,t){function n(e){try{o(c.next(e))}catch(e){t(e)}}function r(e){try{o(c.throw(e))}catch(e){t(e)}}function o(t){var o;t.done?e(t.value):(o=t.value,o instanceof s?o:new s((function(e){e(o)}))).then(n,r)}o((c=c.apply(a,i||[])).next())}))).catch((function(e){if("ApiError"===e.name)o(e);else{var t=new l("unknown-error",e.message,500);o(t)}}))}}var d=new o.Schema({firebaseId:{type:String,require:[!0,"Firebase id is required"]},name:{type:String,default:""},email:{type:String,require:[!0,"Email is required"]},phoneNumber:{type:String,unique:!0,default:""},apiKey:{type:String,default:""},billingEnabled:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},googleConfig:{type:{},default:null},appleConfig:{type:{secret:{type:String,default:""}},default:{secret:""}},amazonConfig:{type:{userId:{type:String,default:""},secret:{type:String,default:""}},default:{userId:"",secret:""}}}),h=(0,o.model)("user",d);const y=require("uuid-apikey");var m=n.n(y),b=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}c((r=r.apply(e,t||[])).next())}))},g=function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},v=function(){function e(e,t,n){this.message="",this.resultCode="00",this.data={},this.data=e,this.message=n,this.resultCode=t}return e.prototype.toJSON=function(){return{data:this.data,message:this.message,resultCode:this.resultCode}},e}(),w=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}c((r=r.apply(e,t||[])).next())}))},x=function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},k=(0,t.Router)();k.use(function(){var t=this;return f((function(n,r,o){return b(t,void 0,void 0,(function(){var t,r,a=this;return g(this,(function(i){switch(i.label){case 0:return(t=null===(r=n.headers.authorization)||void 0===r?void 0:r.replace("Bearer ","").trim())?[4,e.auth().verifyIdToken(t).then((function(e){return b(a,void 0,void 0,(function(){var t,r,a;return g(this,(function(i){switch(i.label){case 0:return t=e.uid,[4,h.findOne({firebaseId:t})];case 1:return(r=i.sent())?(n.user=r,o()):(console.log("User not found hence creating"),a={firebaseId:t,email:e.email,apiKey:m().create().apiKey},h.create(a,(function(e,t){if(e)throw console.log("Error creating: "+e.message),new l("failed-creating-object",e.message);n.user=t,o()}))),[2]}}))}))})).catch((function(e){throw new l("user-not-found","User not found!",404)}))]:[3,2];case 1:return i.sent(),[3,3];case 2:throw new l("invalid-jwt","Invalid jwt",401);case 3:return[2]}}))}))}))}()),k.put("/",f((function(e,t){return w(void 0,void 0,void 0,(function(){var n,r;return x(this,(function(o){switch(o.label){case 0:Object.assign(e.user,e.body),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,e.user.save()];case 2:return void 0!==(n=o.sent())&&t.send(new v(n).toJSON()),[3,4];case 3:throw r=o.sent(),console.log(r),new l("unknown-error",r.message,400);case 4:return[2]}}))}))}))),k.get("/",f((function(e,t){return w(void 0,void 0,void 0,(function(){return x(this,(function(n){return t.send(new v(e.user).toJSON()),[2]}))}))})));var S={RATE_PER_REQUEST:.3,GRACE_PERIOD:7,FREE_ALLOWANCE:50,MONTH_NAMES:["January","February","March","April","May","June","July","August","September","October","November","December"]},I=new o.Schema({userId:{type:String,require:[!0,"User Id is required"]},requestsStats:{type:[{date:{type:Number,require:[!0,"Date is required"]},platform:{type:String,require:[!0,"Platform is required"]},appId:{type:String,require:[!0,"AppId is required"]},countForThisCombo:{type:Number}}]}}),E=(0,o.model)("userStatistic",I),_=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,a=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(r=a.next()).done;)i.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=a.return)&&n.call(a)}finally{if(o)throw o.error}}return i};function D(e,t,n,r,o){return void 0===r&&(r=""),void 0===o&&(o=""),a=this,i=void 0,c=function(){var a,i,s,c,l,u,p,f,d,h,y,m,b,g,v,w,x,k,I,D;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}(this,(function(T){switch(T.label){case 0:return[4,E.findOne({userId:e._id})];case 1:if(a=T.sent()){for(i=null==a?void 0:a.requestsStats.filter((function(e){return t===new Date(e.date).getMonth()&&n===new Date(e.date).getFullYear()})),s=0,c=new Map,l=0;l<i.length;l++)u=i[l].countForThisCombo,s+=u,p=i[l].platform,f=i[l].appId,g=p+" "+f,void 0===c.get(g)?c.set(g,u):(d=c.get(g),c.set(g,d+u));h=[];try{for(y=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(c.entries()),m=y.next();!m.done;m=y.next())b=_(m.value,2),g=b[0],v=b[1],w={platform:g.split(" ")[0],appId:g.split(" ")[1],count:v,totalPrice:v*S.RATE_PER_REQUEST},h.push(w)}catch(e){I={error:e}}finally{try{m&&!m.done&&(D=y.return)&&D.call(y)}finally{if(I)throw I.error}}return x={rate:S.RATE_PER_REQUEST,freeAllowance:S.FREE_ALLOWANCE,totalCount:s,statistics:h},""!==o&&""===r?(k=x.statistics.filter((function(e){return e.appId===o})),x.statistics=k):""!==r&&""===o?(k=x.statistics.filter((function(e){return e.platform===r})),x.statistics=k):""!==r&&""!==o&&(k=x.statistics.filter((function(e){return e.platform===r&&e.appId===o})),x.statistics=k),[2,x]}return[2,{rate:S.RATE_PER_REQUEST,freeAllowance:S.FREE_ALLOWANCE,totalCount:0,statistics:[]}]}}))},new((s=void 0)||(s=Promise))((function(e,t){function n(e){try{o(c.next(e))}catch(e){t(e)}}function r(e){try{o(c.throw(e))}catch(e){t(e)}}function o(t){var o;t.done?e(t.value):(o=t.value,o instanceof s?o:new s((function(e){e(o)}))).then(n,r)}o((c=c.apply(a,i||[])).next())}));var a,i,s,c}var T=n(605),q=function(e,t,n,r){return new(n||(n=Promise))((function(o,a){function i(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}c((r=r.apply(e,t||[])).next())}))},C=function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}},R=(0,t.Router)();R.use(function(){var e=this;return f((function(t,n,r){return o=e,a=void 0,s=function(){var e,n;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}(this,(function(o){switch(o.label){case 0:return(e=t.query.apiKey)?[4,h.findOne({apiKey:e})]:[3,2];case 1:if(n=o.sent(),console.log("User: "+n),!n)throw new l("invalid-api-key","User not found. Invalid Api key",404);return t.user=n,r(),[3,3];case 2:throw new l("no-api-key-found","No api key",401);case 3:return[2]}}))},new((i=void 0)||(i=Promise))((function(e,t){function n(e){try{c(s.next(e))}catch(e){t(e)}}function r(e){try{c(s.throw(e))}catch(e){t(e)}}function c(t){var o;t.done?e(t.value):(o=t.value,o instanceof i?o:new i((function(e){e(o)}))).then(n,r)}c((s=s.apply(o,a||[])).next())}));var o,a,i,s}))}()),R.post("/",f((function(e,t,n){return q(void 0,void 0,void 0,(function(){var n,r,o;return C(this,(function(a){switch(a.label){case 0:return n=e.body.platform,r=e.body.paymentData,e.user.disabled?[3,5]:[4,D(e.user,(new Date).getMonth(),(new Date).getFullYear())];case 1:if(o=a.sent().totalCount,e.user.billingEnabled||!(o>=S.FREE_ALLOWANCE))return[3,2];throw new l("billing-disabled","Request rejected. You have exceeded the free limit. Kindly enable the billing option to continue using our service!");case 2:return function(e,t,n){var r,o,a,i,s;o=this,a=void 0,s=function(){var o,a,i;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}(this,(function(s){switch(s.label){case 0:return[4,E.findOne({userId:e._id})];case 1:return(o=s.sent())?[3,2]:(a=function(e,t,n,r,o){return{userId:e,requestsStats:[{date:Date.now(),platform:t,appId:n,countForThisCombo:1}]}}(e._id,t,n),E.create(a,(function(e,t){if(e)throw new l("failed-creating-object",e.message)})),[3,4]);case 2:return-1==(i=o.requestsStats.findIndex((function(e){return new Date(e.date).toDateString()==(new Date).toDateString()&&e.platform===t&&e.appId===n})))?null===(r=o.requestsStats)||void 0===r||r.push({date:Date.now(),platform:t,appId:n,countForThisCombo:1}):o.requestsStats[i].countForThisCombo=o.requestsStats[i].countForThisCombo+1,[4,o.save()];case 3:s.sent(),s.label=4;case 4:return[2]}}))},new((i=void 0)||(i=Promise))((function(e,t){function n(e){try{c(s.next(e))}catch(e){t(e)}}function r(e){try{c(s.throw(e))}catch(e){t(e)}}function c(t){var o;t.done?e(t.value):(o=t.value,o instanceof i?o:new i((function(e){e(o)}))).then(n,r)}c((s=s.apply(o,a||[])).next())}))}(e.user,n,r.packageName),[4,new Promise((function(e,o){T.verifyPayment(n,r,(function(n,r){return q(void 0,void 0,void 0,(function(){return C(this,(function(a){return r?(e(r),t.send(new v(r))):o(new l("verification-failed",n.message,400)),[2]}))}))}))}))];case 3:a.sent(),a.label=4;case 4:return[3,6];case 5:throw new l("user-disabled","Request rejected. Kindly complete your previous pending payment to continue using our service!");case 6:return[2]}}))}))})));var A=(0,t.Router)();A.use("/auth/profile",k),A.use("/verify",R);const P=require("cron");var O=new o.Schema({userId:{type:String,require:[!0]},invoiceDisplayId:{type:Number,require:[!0]},billDetails:{type:{rate:{type:Number,require:[!0]},freeAllowance:{type:Number,require:[!0]},totalCount:{type:Number,require:[!0]},statistics:{type:[{platform:{type:String,require:[!0]},appId:{type:String,require:[!0]},count:{type:Number,require:[!0]},totalPrice:{type:Number,require:[!0]}}]}},require:[!0]},amount:{type:Number,require:[!0]},currencyCode:{type:String},transactionId:{type:String},paid:{type:Boolean,default:!1}},{timestamps:!0}),N=(0,o.model)("invoice",O);function M(){return'<!DOCTYPE html>\n    <html>\n        <head>\n            <meta charset="utf-8">\n            <meta http-equiv="x-ua-compatible" content="ie=edge">\n            <title>Invoice</title>\n            <meta name="viewport" content="width=device-width, initial-scale=1">\n            <link rel="preconnect" href="https://fonts.gstatic.com">\n            <link href="https://fonts.googleapis.com/css2?family=Coda&display=swap" rel="stylesheet">\n            <link href="https://fonts.googleapis.com/css2?family=Coda:wght@400;800&display=swap" rel="stylesheet">\n            <style type="text/css">\n                * {\n                    font-family: \'Coda\';\n                }\n        \n                body,\n                table,\n                td,\n                a {\n        \n                    -ms-text-size-adjust: 100%;\n                    /* 1 */\n                    -webkit-text-size-adjust: 100%;\n                    /* 2 */\n                }\n        \n                /**\n         * Remove extra space added to tables and cells in Outlook.\n         */\n                table,\n                td {\n                    mso-table-rspace: 0pt;\n                    mso-table-lspace: 0pt;\n                }\n        \n                /**\n         * Better fluid images in Internet Explorer.\n         */\n                img {\n                    -ms-interpolation-mode: bicubic;\n                }\n        \n                /**\n         * Remove blue links for iOS devices.\n         */\n                a[x-apple-data-detectors] {\n                    font-family: inherit !important;\n                    font-size: inherit !important;\n                    font-weight: inherit !important;\n                    line-height: inherit !important;\n                    color: inherit !important;\n                    text-decoration: none !important;\n                }\n        \n                /**\n         * Fix centering issues in Android 4.4.\n         */\n                div[style*="margin: 16px 0;"] {\n                    margin: 0 !important;\n                }\n        \n                body {\n                    width: 100% !important;\n                    height: 100% !important;\n                    padding: 0 !important;\n                    margin: 0 !important;\n                }\n                table {\n                    border-collapse: collapse !important;\n                }\n        \n                a {\n                    color: #fc5350;\n                }\n        \n                img {\n                    height: auto;\n                    line-height: 100%;\n                    text-decoration: none;\n                    border: 0;\n                    outline: none;\n                }\n            </style>\n        \n        </head>\n        \n        <body style="background-color: #e9ecef;">\n        \n            \x3c!-- start preheader --\x3e\n            <div class="preheader"\n                style="display: none; max-width: 0; max-height: 0; overflow: hidden; font-size: 1px; line-height: 1px; color: #fff; opacity: 0;">\n                Invoice\n            </div>\n            \x3c!-- end preheader --\x3e\n        \n            \x3c!-- start body --\x3e\n            <table border="0" cellpadding="0" cellspacing="0" width="100%">\n        \n                \x3c!-- start logo --\x3e\n                <tr>\n                    <td align="center" bgcolor="#e9ecef">\n\n                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px;">\n                            <tr>\n                                <td align="center" valign="top" style="padding: 18px 12px;">\n                                    \n                                </td>\n                            </tr>\n                        </table>\n                    </td>\n                </tr>\n                \x3c!-- end logo --\x3e\n        \n                \x3c!-- start hero --\x3e\n                <tr>\n                    <td align="center" bgcolor="#e9ecef">\n                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px;">\n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 36px 24px 0; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; border-top: 3px solid #d4dadf;">\n                                    <h1\n                                        style="margin: 0; font-size: 32px; font-weight: 700; letter-spacing: -1px; line-height: 48px;">\n                                        Your invoice for {{month}} is ready</h1>\n                                </td>\n                            </tr>\n                        </table>\n                        \x3c!--[if (gte mso 9)|(IE)]>\n                </td>\n                </tr>\n                </table>\n                <![endif]--\x3e\n                    </td>\n                </tr>\n                \x3c!-- end hero --\x3e\n        \n                \x3c!-- start copy block --\x3e\n                <tr>\n                    <td align="center" bgcolor="#e9ecef">\n                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px;">\n        \n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 24px; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; font-size: 16px; line-height: 24px;">\n                                    <p style="margin: 0;">We thank you for using our service!</p>\n                                </td>\n                            </tr>\n                            \n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 24px; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; font-size: 16px; line-height: 24px;">\n                                    <p style="margin: 0;">Your invoice for {{month}}, {{year}} is ready. Kindly make the payment <a style="color: #fc5350;" href={{paymentUrl}} target="_blank">here</a> by {{dueDate}}. You can also complete the payment by visiting your dashboard at\n                                    <a style="color: #fc5350;" href="www.somewebsite.com" target="_blank">www.somewebsite.com</a></p>\n                                    </p>\n                                    <p style="margin: 0;">If the pdf looks corrupted. Kindly contact us at</p>\n                                    <a style="color: #fc5350;" href="hello@cryvis.com" target="_blank">hello@cryvis.com</a>\n                                </td>\n                            </tr>\n        \n                            \x3c!-- start copy --\x3e\n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 24px; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; font-size: 16px; line-height: 24px; border-bottom: 3px solid #d4dadf">\n                                    <p style="margin: 0;">Cheers,<br> Team Cryvis</p>\n                                </td>\n                            </tr>\n                            \x3c!-- end copy --\x3e\n        \n                        </table>\n                    </td>\n                </tr>\n            </table>        \n        </body>\n        </html>'}n(778);var B=n(123),U=n(747),j=n(778);function F(e,t,n,r,o,a){var i,s;0===(new Date).getMonth()?(i=S.MONTH_NAMES[11],s=(new Date).getFullYear()-1):(i=S.MONTH_NAMES[(new Date).getMonth()-1],s=s=(new Date).getFullYear());var c=B.createTransport({service:"gmail",auth:{user:"astronauak@gmail.com",pass:"Astronaut@123"}}),l=j.compile(a());console.log("after template");var u={from:"astronauak@gmail.com",to:t,subject:n,html:l({dueDate:r.toLocaleString(),month:i,year:s,paymentUrl:o}),attachments:[{filename:"invoice.pdf",path:"./src/pdfstorage/output.pdf"}]};c.sendMail(u,(function(e,t){e?console.log(e):(console.log("Email sent: "+t.response),U.unlinkSync("./src/pdfstorage/output.pdf"))}))}var J=n(487),z=n(747),G={};function Y(e){return t=this,n=void 0,o=function(){var t,n;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}(this,(function(r){switch(r.label){case 0:return[4,z.readFileSync("src/utils/html/invoice.html","utf8")];case 1:return t=r.sent(),n={html:t,data:{bill:e},path:"./src/pdfstorage/output.pdf",type:""},[4,J.create(n,G).then((function(e){console.log(e)})).catch((function(e){console.error(e)}))];case 2:return r.sent(),console.log("Pdf created"),[2]}}))},new((r=void 0)||(r=Promise))((function(e,a){function i(e){try{c(o.next(e))}catch(e){a(e)}}function s(e){try{c(o.throw(e))}catch(e){a(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(i,s)}c((o=o.apply(t,n||[])).next())}));var t,n,r,o}var L=new P.CronJob("* * * * *",(function(){return e=this,t=void 0,r=function(){var e,t,n,r,o,a,i,s,c,l,u,p,f;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}(this,(function(d){switch(d.label){case 0:return[4,h.find({})];case 1:e=d.sent(),t=new Date((new Date).setDate((new Date).getDate()+7)),d.label=2;case 2:d.trys.push([2,13,14,15]),n=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(e),r=n.next(),d.label=3;case 3:return r.done?[3,12]:(o=r.value,0!==(new Date).getMonth()?[3,5]:[4,D(o,11,(new Date).getFullYear()-1)]);case 4:return a=d.sent(),[3,7];case 5:return[4,D(o,(new Date).getMonth()-1,(new Date).getFullYear())];case 6:a=d.sent(),d.label=7;case 7:return(i=Math.max(0,a.totalCount-S.FREE_ALLOWANCE)*S.RATE_PER_REQUEST)>0?[4,N.findOne({},{},{sort:{created_at:-1}})]:[3,11];case 8:return s=d.sent(),c=s?(s.invoiceDisplayId+1)%Math.pow(10,7):1,[4,N.create({userId:o._id,invoiceDisplayId:c,billDetails:a,amount:i})];case 9:return l=d.sent(),Object.assign(a,{name:o.name,email:o.email,invoiceId:l.invoiceDisplayId,dueDate:t.toDateString(),currDate:(new Date).toDateString(),subTotal:a.totalCount*S.RATE_PER_REQUEST,billedRequests:Math.max(0,a.totalCount-S.FREE_ALLOWANCE),amountPayable:i}),[4,Y(a)];case 10:d.sent(),F(0,o.email,"Test Mail",t,"www.google.com",M),d.label=11;case 11:return r=n.next(),[3,3];case 12:return[3,15];case 13:return u=d.sent(),p={error:u},[3,15];case 14:try{r&&!r.done&&(f=n.return)&&f.call(n)}finally{if(p)throw p.error}return[7];case 15:return[2]}}))},new((n=void 0)||(n=Promise))((function(o,a){function i(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}c((r=r.apply(e,t||[])).next())}));var e,t,n,r}),null,!0,"Asia/Kolkata");function K(){return'<!DOCTYPE html>\n    <html>\n        <head>\n            <meta charset="utf-8">\n            <meta http-equiv="x-ua-compatible" content="ie=edge">\n            <title>Invoice</title>\n            <meta name="viewport" content="width=device-width, initial-scale=1">\n            <link rel="preconnect" href="https://fonts.gstatic.com">\n            <link href="https://fonts.googleapis.com/css2?family=Coda&display=swap" rel="stylesheet">\n            <link href="https://fonts.googleapis.com/css2?family=Coda:wght@400;800&display=swap" rel="stylesheet">\n            <style type="text/css">\n                * {\n                    font-family: \'Coda\';\n                }\n        \n                body,\n                table,\n                td,\n                a {\n        \n                    -ms-text-size-adjust: 100%;\n                    /* 1 */\n                    -webkit-text-size-adjust: 100%;\n                    /* 2 */\n                }\n        \n                /**\n         * Remove extra space added to tables and cells in Outlook.\n         */\n                table,\n                td {\n                    mso-table-rspace: 0pt;\n                    mso-table-lspace: 0pt;\n                }\n        \n                /**\n         * Better fluid images in Internet Explorer.\n         */\n                img {\n                    -ms-interpolation-mode: bicubic;\n                }\n        \n                /**\n         * Remove blue links for iOS devices.\n         */\n                a[x-apple-data-detectors] {\n                    font-family: inherit !important;\n                    font-size: inherit !important;\n                    font-weight: inherit !important;\n                    line-height: inherit !important;\n                    color: inherit !important;\n                    text-decoration: none !important;\n                }\n        \n                /**\n         * Fix centering issues in Android 4.4.\n         */\n                div[style*="margin: 16px 0;"] {\n                    margin: 0 !important;\n                }\n        \n                body {\n                    width: 100% !important;\n                    height: 100% !important;\n                    padding: 0 !important;\n                    margin: 0 !important;\n                }\n                table {\n                    border-collapse: collapse !important;\n                }\n        \n                a {\n                    color: #fc5350;\n                }\n        \n                img {\n                    height: auto;\n                    line-height: 100%;\n                    text-decoration: none;\n                    border: 0;\n                    outline: none;\n                }\n            </style>\n        \n        </head>\n        \n        <body style="background-color: #e9ecef;">\n        \n            \x3c!-- start preheader --\x3e\n            <div class="preheader"\n                style="display: none; max-width: 0; max-height: 0; overflow: hidden; font-size: 1px; line-height: 1px; color: #fff; opacity: 0;">\n                Invoice\n            </div>\n            \x3c!-- end preheader --\x3e\n        \n            \x3c!-- start body --\x3e\n            <table border="0" cellpadding="0" cellspacing="0" width="100%">\n        \n                \x3c!-- start logo --\x3e\n                <tr>\n                    <td align="center" bgcolor="#e9ecef">\n\n                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px;">\n                            <tr>\n                                <td align="center" valign="top" style="padding: 18px 12px;">\n                                    \n                                </td>\n                            </tr>\n                        </table>\n                    </td>\n                </tr>\n                \x3c!-- end logo --\x3e\n        \n                \x3c!-- start hero --\x3e\n                <tr>\n                    <td align="center" bgcolor="#e9ecef">\n                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px;">\n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 36px 24px 0; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; border-top: 3px solid #d4dadf;">\n                                    <h1\n                                        style="margin: 0; font-size: 32px; font-weight: 700; letter-spacing: -1px; line-height: 48px;">\n                                        Your payment is due</h1>\n                                </td>\n                            </tr>\n                        </table>\n                        \x3c!--[if (gte mso 9)|(IE)]>\n                </td>\n                </tr>\n                </table>\n                <![endif]--\x3e\n                    </td>\n                </tr>\n                \x3c!-- end hero --\x3e\n        \n                \x3c!-- start copy block --\x3e\n                <tr>\n                    <td align="center" bgcolor="#e9ecef">\n                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px;">\n        \n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 24px; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; font-size: 16px; line-height: 24px;">\n                                    <p style="margin: 0;">We thank you for using our service!</p>\n                                </td>\n                            </tr>\n                     \n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 24px; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; font-size: 16px; line-height: 24px;">\n                                    <p style="margin: 0;">The due date for completing the payment has passed.\n                                    Your service is suspended.\n                                    Kindly complete your payment for the last month, <a style="color: #fc5350;" href={{paymentUrl}} target="_blank">here</a> to continue using our service. \n                                    You can also complete the payment by visiting your dashboard at\n                                    <a style="color: #fc5350;" href="www.somewebsite.com" target="_blank">www.somewebsite.com</a></p>\n                                    </p>\n                                    <p style="margin: 0;">If the pdf looks corrupted. Kindly contact us at</p>\n                                    <a style="color: #fc5350;" href="hello@cryvis.com" target="_blank">hello@cryvis.com</a>\n                                </td>\n                            </tr>\n        \n                            \x3c!-- start copy --\x3e\n                            <tr>\n                                <td align="left" bgcolor="#ffffff"\n                                    style="padding: 24px; font-family: \'Source Sans Pro\', Helvetica, Arial, sans-serif; font-size: 16px; line-height: 24px; border-bottom: 3px solid #d4dadf">\n                                    <p style="margin: 0;">Cheers,<br> Team Cryvis</p>\n                                </td>\n                            </tr>\n                            \x3c!-- end copy --\x3e\n        \n                        </table>\n                    </td>\n                </tr>\n            </table>        \n        </body>\n        </html>'}n(778);var Q=new P.CronJob("* * * * *",(function(){return e=this,t=void 0,r=function(){var e,t,n,r,o,a,i,s,c,l;return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}(this,(function(u){switch(u.label){case 0:return[4,h.find({})];case 1:e=u.sent(),t=new Date((new Date).setDate((new Date).getDate()+7)),u.label=2;case 2:u.trys.push([2,9,10,11]),n=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(e),r=n.next(),u.label=3;case 3:return r.done?[3,8]:(o=r.value,[4,N.findOne({userId:o._id},{},{sort:{created_at:-1}})]);case 4:return!(a=u.sent())||(null==a?void 0:a.paid)?[3,7]:(i=a.billDetails,Object.assign(i,{name:o.name,email:o.email,invoiceId:a.invoiceDisplayId,dueDate:t.toDateString(),currDate:(new Date).toDateString(),subTotal:i.totalCount*S.RATE_PER_REQUEST,billedRequests:Math.max(0,i.totalCount-S.FREE_ALLOWANCE),amountPayable:a.amount}),console.log("Cron grace running..."),[4,Y(i)]);case 5:return u.sent(),F(0,o.email,"Test Mail",t,"www.google.com",K),o.disabled=!0,[4,o.save()];case 6:u.sent(),u.label=7;case 7:return r=n.next(),[3,3];case 8:return[3,11];case 9:return s=u.sent(),c={error:s},[3,11];case 10:try{r&&!r.done&&(l=n.return)&&l.call(n)}finally{if(c)throw c.error}return[7];case 11:return[2]}}))},new((n=void 0)||(n=Promise))((function(o,a){function i(e){try{c(r.next(e))}catch(e){a(e)}}function s(e){try{c(r.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}c((r=r.apply(e,t||[])).next())}));var e,t,n,r}),null,!0,"Asia/Kolkata"),W=r()(),H=n(318);L.start(),Q.start(),e.initializeApp({credential:e.credential.cert(H)}),W.use(s()()),W.use(c),W.use(A),W.use((function(e,t,n,r){e.constructor===l&&"ApiError"===e.name?n.status(e.responseCode).send(e.toResponseData()):(n.sendStatus(500),console.log(e))}));var Z=p().createServer(W);a().connect("mongodb://127.0.0.1:27017/IAPService",{useNewUrlParser:!0,useUnifiedTopology:!0,useCreateIndex:!0}).then((function(){Z.listen(process.env.PORT||8080,(function(){console.log("Server Running...")}))}))})()})();
